<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contactos Sub Oficina OCHA Maracaibo</title>

    <!-- Google Fonts: Roboto Slab & Roboto Condensed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- jQuery (cargar PRIMERO) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- QR Code Generator (cargar TEMPRANO) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- SheetJS para manejo de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Variables de colores OCHA */
        :root {
            --color-ochablue: #005392;
            --color-ochayellow: #FFC72C;
            --color-ochagrey: #808080;
            --color-ochaprimarytext: #333333;
            --color-ochasecondarytext: #666666;
            --ocha-light-gray: #F5F5F5;
            --ocha-dark-gray: #3A3A3A;
            --ocha-white: #FFFFFF;
            --ocha-black: #000000;
            --ocha-red: #CD3A1F;
            --ocha-green: #7DBA00;
            --ocha-light-blue: #E6F3FF;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto Condensed', Arial, sans-serif;
            background-color: var(--ocha-light-gray);
            color: var(--color-ochaprimarytext);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Login Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-ochablue) 0%, #005a8a 100%);
            padding: 1rem;
        }

        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .login-logo img {
            height: 60px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-main-title {
            font-family: 'Roboto Slab', serif;
            color: var(--color-ochablue);
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .login-form-title {
            color: var(--ocha-dark-gray);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-ochagrey);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-ochablue);
            box-shadow: 0 0 0 3px rgba(0, 114, 188, 0.1);
        }

        /* Password field with toggle */
        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--color-ochagrey);
            background: none;
            border: none;
            font-size: 1rem;
            padding: 0;
        }

        .password-toggle:hover {
            color: var(--color-ochablue);
        }

        .no-auth #loginPage { display: none !important; }
        .no-auth #mainApp { display: block !important; }
        /* Al pedir clave, ocultamos la página de login y mantenemos el fondo azul visible */
        .access-locked #loginPage { display: none !important; }
        .access-locked #mainApp { display: none !important; }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--color-ochablue);
            color: white;
        }
        .btn-primary:hover {
            background-color: #005a8a;
        }
        
        .btn-secondary {
            background-color: var(--color-ochagrey);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--ocha-dark-gray);
        }

        .btn-danger {
            background-color: var(--ocha-red);
            color: white;
        }
        .btn-danger:hover {
            background-color: #a02d17;
        }

        .btn-success {
            background-color: var(--ocha-green);
            color: white;
        }
        .btn-success:hover {
            background-color: #649600;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
        }

        .btn-warning {
            background-color: var(--color-ochayellow);
            color: var(--ocha-dark-gray);
        }
        .btn-warning:hover {
            background-color: #e6b328;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Header Styles - Mejorado para laptops */
        .header {
            background-color: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .header-logo {
            height: 50px;
        }

        .header-title h1 {
            font-family: 'Roboto Slab', serif;
            font-size: 1.4rem;
            color: var(--color-ochablue);
            font-weight: 700;
            margin: 0;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: var(--color-ochasecondarytext);
            margin-top: 0.25rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--ocha-light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Main Layout - Optimizado para laptops */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            min-height: calc(100vh - 120px);
            flex: 1;
            width: 100%;
        }

        /* Sidebar optimizada */
        .sidebar {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            height: fit-content;
            position: sticky;
            top: 120px;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
        }

        /* Área principal más fluida */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 0;
        }

        /* KPI Cards - Optimizadas para laptops */
        .kpi-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--ocha-light-blue) 0%, #fff 100%);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-ochablue);
        }

        .kpi-icon {
            font-size: 2.5rem;
            color: var(--color-ochablue);
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ocha-dark-gray);
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--color-ochagrey);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Filters mejorados */
        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-title {
            font-size: 1rem;
            color: var(--ocha-dark-gray);
            margin-bottom: 0.75rem;
            font-weight: 600;
            border-bottom: 2px solid var(--ocha-light-blue);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-title i {
            color: var(--color-ochablue);
        }

        .filter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .filter-select:hover {
            border-color: var(--color-ochablue);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--color-ochablue);
            box-shadow: 0 0 0 2px rgba(0, 114, 188, 0.1);
        }

        /* Icon Grid for sectors - Mejorada para laptops */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .icon-item {
            background: var(--ocha-light-gray);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .icon-item:hover {
            background: var(--ocha-light-blue);
            border-color: var(--color-ochablue);
            transform: scale(1.05);
        }

        .icon-item.active {
            background: var(--color-ochablue);
            color: white;
            border-color: #005a8a;
        }

        .icon-item.active .sector-icon {
            filter: brightness(0) invert(1);
        }

        .sector-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 0.3rem;
            display: block;
            filter: brightness(0) saturate(100%) invert(28%) sepia(94%) saturate(1234%) hue-rotate(195deg) brightness(89%) contrast(91%);
        }

        .sector-name {
            font-size: 0.7rem;
            font-weight: 500;
            word-break: break-word;
            line-height: 1.1;
            text-align: center;
        }

        /* Table Styles - Optimizada para laptops */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            flex: 1;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--color-ochablue);
            box-shadow: 0 0 0 3px rgba(0, 114, 188, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-ochagrey);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Selection Controls */
        .selection-controls {
            background: var(--ocha-light-blue);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .selection-controls.active {
            display: block;
        }

        .selection-info {
            font-weight: 600;
            color: var(--color-ochablue);
            margin-bottom: 0.5rem;
        }

        .selection-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-wrapper {
            overflow: auto;
            flex: 1;
            border-radius: 8px;
            border: 1px solid #eee;
            max-height: 600px;
        }

        .contacts-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .contacts-table th {
            background: linear-gradient(180deg, var(--ocha-light-gray) 0%, #e8e8e8 100%);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--ocha-dark-gray);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
            font-size: 0.85rem;
        }

        .contacts-table th:hover {
            background: linear-gradient(180deg, #e0e0e0 0%, #d0d0d0 100%);
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8rem;
            color: var(--color-ochagrey);
        }

        .contacts-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }

        .contacts-table tr {
            transition: background 0.2s;
        }

        .contacts-table tr:hover {
            background: var(--ocha-light-blue);
        }

        .contact-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .copy-icon, .whatsapp-icon {
            cursor: pointer;
            margin-left: 8px;
            color: var(--color-ochagrey);
            transition: color 0.3s;
        }

        .copy-icon:hover {
            color: var(--color-ochablue);
        }

        .whatsapp-icon {
            color: #25D366;
        }

        .whatsapp-icon:hover {
            color: #128C7E;
        }

        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            justify-content: flex-start;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .action-btn-view {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .action-btn-edit {
            background: linear-gradient(135deg, var(--color-ochablue), #005a8a);
            color: white;
        }

        .action-btn-delete {
            background: linear-gradient(135deg, var(--ocha-red), #a02d17);
            color: white;
        }

        .action-btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
        }

        .action-btn-qr {
            background: linear-gradient(135deg, var(--color-ochayellow), #e6b328);
            color: var(--ocha-dark-gray);
        }

        /* Tooltip para los botones de acción */
        .action-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ocha-dark-gray);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
        }

        .action-btn::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border: 3px solid transparent;
            border-top-color: var(--ocha-dark-gray);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .action-btn:hover::before,
        .action-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Magic Link Button */
        .magic-link-container {
            margin-top: 1rem;
            text-align: center;
            padding: 1rem;
            background: var(--ocha-light-blue);
            border-radius: 8px;
        }

        .magic-link-btn {
            background: linear-gradient(135deg, var(--color-ochablue), #005a8a);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .magic-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 114, 188, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(11,116,192,0.85) 0%, rgba(0,90,138,0.85) 100%); /* Overlay azul alineado con update-password */
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 14px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 18px 48px rgba(0,0,0,0.14);
            padding: 1.75rem;
            position: relative;
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--ocha-light-blue) 0%, white 100%);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--ocha-dark-gray);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-ochagrey);
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--ocha-red);
        }

        .modal-body {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: var(--ocha-light-gray);
            flex-shrink: 0;
        }

        /* QR Code Modal Specific Styles */
        .qr-modal {
            max-width: 400px;
        }

        .qr-container {
            text-align: center;
            padding: 1rem;
        }

        .qr-code {
            margin: 1rem auto;
            border: 2px solid var(--ocha-light-gray);
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }

        .qr-info {
            background: var(--ocha-light-blue);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: var(--ocha-dark-gray);
        }

        /* Form Grid Layout */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        /* Admin Modal */
        .admin-modal {
            max-width: 500px;
        }

        .admin-input {
            margin: 1rem 0;
        }

        /* Multi-select styling */
        .multi-select-container {
            margin-bottom: 1rem;
        }

        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            background: white;
        }

        .multi-select-item {
            display: flex;
            align-items: center;
            padding: 0.25rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .multi-select-item:hover {
            background: var(--ocha-light-blue);
        }

        .multi-select-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Checkbox Grid */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 0.875rem;
        }
		/* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
   
		.status-info {
            background: #e2f3fe;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Email requirement notice */
        .email-notice {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #1976d2;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--ocha-light-gray);
            border-top: 3px solid var(--color-ochablue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Group List Styles */
.group-list {
    margin-top: 1.5rem;
}

.group-list h5 {
    color: var(--color-ochablue);
    margin-bottom: 0.75rem;
    font-size: 1rem;
}

.group-item {
    background: var(--ocha-light-blue);
    border: 1px solid var(--color-ochablue);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
}

.group-item:hover {
    background: var(--color-ochablue);
    color: white;
}

.group-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

/* NUEVO: Estilos para Modal Avanzado de Grupos (Dos Niveles) */
.groups-view {
    animation: fadeIn 0.3s ease-in-out;
}

.group-list-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    position: relative;
}

.group-list-card:hover {
    border-color: var(--color-ochablue);
    box-shadow: 0 4px 12px rgba(0, 83, 146, 0.1);
    transform: translateY(-2px);
}

.group-list-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.group-list-card-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--color-ochablue);
    margin: 0 0 0.25rem 0;
}

.group-list-card-count {
    background: var(--color-ochablue);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.group-list-card-description {
    font-size: 0.9rem;
    color: var(--color-ochagrey);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.group-list-card-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

.group-list-card-actions .btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

/* Estilos para lista de miembros con checkboxes */
.member-checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
}

.member-checkbox-item:hover {
    background: #f8f9fa;
    border-color: var(--color-ochablue);
}

.member-checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 1rem;
    cursor: pointer;
    accent-color: var(--color-ochablue);
}

.member-checkbox-item label {
    cursor: pointer;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin: 0;
}

.member-checkbox-name {
    font-weight: 600;
    color: var(--color-ochaprimarytext);
    font-size: 0.95rem;
}

.member-checkbox-org {
    font-size: 0.85rem;
    color: var(--color-ochagrey);
}

.member-checkbox-item input[type="checkbox"]:checked + label {
    color: var(--color-ochablue);
}

.member-checkbox-item input[type="checkbox"]:checked + label .member-checkbox-name {
    color: var(--color-ochablue);
    font-weight: 700;
}

.member-checkbox-item.checked {
    background: var(--ocha-light-blue);
    border-color: var(--color-ochablue);
}

.group-item-name {
    font-weight: 600;
    font-size: 0.9rem;
}

.group-item-count {
    font-size: 0.8rem;
    opacity: 0.8;
}

.group-item-description {
    font-size: 0.8rem;
    opacity: 0.9;
}

/* Group Filter Styles */
.groups-filter-container {
    max-height: 300px;
    overflow-y: auto;
}

.group-filter-item {
    background: var(--ocha-light-gray);
    border: 1px solid var(--color-ochagrey);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.group-filter-item:hover {
    background: var(--ocha-light-blue);
    border-color: var(--color-ochablue);
    transform: translateY(-1px);
}

.group-filter-item.active {
    background: var(--color-ochablue);
    color: white;
    border-color: #005a8a;
}

.group-filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.group-filter-name {
    font-weight: 600;
    font-size: 0.9rem;
    flex: 1;
}

.group-filter-count {
    font-size: 0.75rem;
    background: rgba(255,255,255,0.8);
    color: var(--color-ochablue);
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-weight: 600;
}

.group-filter-item.active .group-filter-count {
    background: rgba(255,255,255,0.9);
    color: var(--color-ochablue);
}

.group-filter-description {
    font-size: 0.8rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

.group-filter-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.3s;
}

.group-filter-item:hover .group-filter-actions {
    opacity: 1;
}

.group-filter-item.active .group-filter-actions {
    opacity: 1;
}

.group-action-btn {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    transition: all 0.3s;
    background: rgba(255,255,255,0.8);
    color: var(--color-ochablue);
}

.group-action-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.group-action-btn.edit {
    background: rgba(0, 114, 188, 0.1);
}

.group-action-btn.delete {
    background: rgba(205, 58, 31, 0.1);
    color: var(--ocha-red);
}

.group-action-btn.edit:hover {
    background: var(--color-ochablue);
    color: white;
}

.group-action-btn.delete:hover {
    background: var(--ocha-red);
    color: white;
}

.no-groups-message {
    text-align: center;
    color: var(--color-ochagrey);
    font-style: italic;
    padding: 1rem;
    font-size: 0.85rem;
}
        /* Footer mejorado */
        .footer {
            background: var(--ocha-dark-gray);
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .footer-section h4 {
            color: var(--color-ochayellow);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .footer-section p, .footer-section a {
            color: #ccc;
            text-decoration: none;
            line-height: 1.8;
            font-size: 0.9rem;
        }

        .footer-section a:hover {
            color: var(--color-ochayellow);
        }

        .footer-section a.mailto-link {
            color: #ccc;
            text-decoration: underline;
        }
        .footer-section a.mailto-link:hover {
            color: var(--color-ochayellow);
        }

        /* Responsive Design Optimizado para Laptops */
        @media (min-width: 1600px) {
            .main-container {
                max-width: 1600px;
                grid-template-columns: 320px 1fr;
                gap: 2rem;
            }
            
            .header-content {
                max-width: 1600px;
                padding: 1rem 2rem;
            }
            
            .footer-content {
                max-width: 1600px;
                padding: 0 2rem;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1200px) and (max-width: 1599px) {
            .main-container {
                grid-template-columns: 300px 1fr;
                padding: 1.5rem;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
            
            .search-box {
                min-width: 350px;
            }
        }

        @media (min-width: 992px) and (max-width: 1199px) {
            .main-container {
                grid-template-columns: 280px 1fr;
                gap: 1.25rem;
                padding: 1.25rem;
            }
            
            .header-title h1 {
                font-size: 1.3rem;
            }
            
            .header-subtitle {
                font-size: 0.8rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        @media (min-width: 768px) and (max-width: 991px) {
            .main-container {
                grid-template-columns: 260px 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            
            .sidebar {
                padding: 1.25rem;
            }
            
            .header-content {
                padding: 1rem;
                flex-direction: row;
            }
            
            .header-brand {
                flex: 1;
            }
            
            .header-actions {
                flex-shrink: 0;
            }
            
            .search-box {
                min-width: 250px;
            }
            
            .table-actions {
                flex-wrap: wrap;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }
        }

        @media (max-width: 767px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0.75rem;
            }
            
            .sidebar {
                position: relative;
                top: auto;
                max-height: none;
                order: -1;
                padding: 1rem;
            }

            .header-content {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .header-brand {
                justify-content: center;
            }

            .header-actions {
                justify-content: center;
            }
            
            .header-title h1 {
                font-size: 1.2rem;
                text-align: center;
            }
            
            .header-subtitle {
                text-align: center;
                font-size: 0.8rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(55px, 1fr));
                gap: 0.5rem;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
                margin-bottom: 1rem;
                min-width: auto;
            }

            .table-actions {
                justify-content: center;
                flex-wrap: wrap;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }
            
            .contacts-table {
                font-size: 0.8rem;
                min-width: 800px;
            }
            
            .contacts-table th, .contacts-table td {
                padding: 0.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-wrap: wrap;
                gap: 0.125rem;
            }

            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .kpi-card {
                padding: 1rem;
            }
            
            .kpi-value {
                font-size: 1.5rem;
            }
            
            .kpi-icon {
                font-size: 2rem;
            }

            .sector-icon {
                width: 24px;
                height: 24px;
            }

            .sector-name {
                font-size: 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .main-container {
                padding: 0.5rem;
            }

            .table-container {
                padding: 1rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }

            .footer-content {
                padding: 0 1rem;
                text-align: center;
            }
            
            .contacts-table {
                min-width: 700px;
            }
        }

        /* Print Styles */
        @media print {
            .header-actions, .sidebar, .table-actions, .selection-controls, .footer {
                display: none !important;
            }
            
            .main-container {
                grid-template-columns: 1fr;
                max-width: 100%;
                padding: 0;
            }
            
            .table-wrapper {
                max-height: none;
                overflow: visible;
            }

            .contacts-table th {
                position: static;
                background-image: none;
                background-color: var(--ocha-light-gray);
                color: var(--ocha-dark-gray);
            }
        }

        /* Mejoras específicas para laptops estándar (1366x768) */
        @media (min-width: 1200px) and (max-height: 800px) {
            .sidebar {
                max-height: calc(100vh - 100px);
                top: 100px;
            }
            
            .table-wrapper {
                max-height: 450px;
            }
            
            .kpi-section {
                padding: 1.25rem;
            }
            
            .table-container {
                padding: 1.25rem;
            }
        }

        /* Mejoras para pantallas ultra-wide */
        @media (min-width: 1900px) {
            .main-container {
                grid-template-columns: 350px 1fr;
                max-width: 1800px;
            }
            
            .sidebar {
                padding: 2rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 1rem;
            }
            
            .sector-icon {
                width: 36px;
                height: 36px;
            }
            
            .sector-name {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="no-auth">
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA Logo">
            </div>
            <h2 class="login-main-title">Sub Oficina OCHA Maracaibo</h2>
            
            <form id="loginForm">
                <h3 class="login-form-title">Ingresar al Sistema (sólo para usuarios de OCHA)</h3>
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Correo Electrónico</label>
                    <input type="email" id="loginEmail" class="form-control" required placeholder="usuario@ejemplo.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Contraseña</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" class="form-control" required placeholder="••••••••">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
                            <i class="fas fa-eye" id="loginPasswordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Ingresar
                </button>
            </form>
            <div id="loginError" class="status-message status-error" style="margin-top: 1rem;"></div>
            <div id="loginSuccess" class="status-message status-success" style="margin-top: 1rem;"></div>

            <form id="registerForm" style="display:none;">
                <h3 class="login-form-title">Crear Cuenta</h3>
                <div class="form-group">
                    <label class="form-label" for="registerEmail">Correo Electrónico</label>
                    <input type="email" id="registerEmail" class="form-control" required placeholder="usuario@ejemplo.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerPassword">Contraseña</label>
                    <div class="password-container">
                        <input type="password" id="registerPassword" class="form-control" required placeholder="••••••••">
                        <button type="button" class="password-toggle" onclick="togglePassword('registerPassword')">
                            <i class="fas fa-eye" id="registerPasswordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-user-plus"></i> Registrarse
                </button>
            </form>
            <div id="registerError" class="status-message status-error" style="margin-top: 1rem;"></div>
            <div id="registerSuccess" class="status-message status-success" style="margin-top: 1rem;"></div>

            <form id="passwordResetForm" style="display:none;">
                <h3 class="login-form-title">Recuperar Contraseña</h3>
                <div class="form-group">
                    <label class="form-label" for="resetEmail">Correo Electrónico</label>
                    <input type="email" id="resetEmail" class="form-control" required placeholder="usuario@ejemplo.com">
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-key"></i> Enviar enlace
                </button>
            </form>
            <div id="resetError" class="status-message status-error" style="margin-top: 1rem;"></div>
            <div id="resetSuccess" class="status-message status-success" style="margin-top: 1rem;"></div>

            <div class="login-links" style="margin-top: 1.5rem; text-align: center;">
                <p id="linkToRegister" style="margin-bottom: 0.5rem;">¿No tienes cuenta? <a href="#" id="showRegisterLink" style="color: var(--color-ochablue); text-decoration: none;">Regístrate</a></p>
                <p id="linkToLoginFromRegister" style="display:none; margin-bottom: 0.5rem;">¿Ya tienes cuenta? <a href="#" id="showLoginFromRegisterLink" style="color: var(--color-ochablue); text-decoration: none;">Ingresa</a></p>
                <p id="linkToPasswordReset">¿Olvidaste tu contraseña? <a href="#" id="showPasswordResetLink" style="color: var(--color-ochablue); text-decoration: none;">Recupérala</a></p>
                <p id="linkToLoginFromReset" style="display:none;">¿Recordaste? <a href="#" id="showLoginFromResetLink" style="color: var(--color-ochablue); text-decoration: none;">Ingresa</a></p>
            </div>

            <!-- Magic Link para actualización de contactos -->
            <div class="magic-link-container">
                <h4 style="color: var(--color-ochablue); margin-bottom: 0.5rem;">
                    <i class="fas fa-magic"></i> Actualización de Contactos
                </h4>
                <p style="font-size: 0.875rem; margin-bottom: 1rem; color: var(--color-ochasecondarytext);">
                    ¿Ya tienes una cuenta? Actualiza tu información directamente
                </p>
                <button type="button" class="magic-link-btn" onclick="generateMagicLink()">
                    <i class="fas fa-link"></i> Generar Enlace de Actualización
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA Logo" class="header-logo">
                    <div class="header-title">
                        <h1>Sub Oficina OCHA Maracaibo</h1>
                        <div class="header-subtitle">Sistema de Gestión de Contactos Humanitarios</div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="userEmail"></span>
                    </div>
                    <button class="btn btn-secondary" onclick="handleLogout()">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar" id="sidebar">
                <div class="filter-section">
                    <h3 class="filter-title"><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
                    
                    <!-- Filtro de texto general -->
                    <div class="form-group">
                        <label class="form-label">Búsqueda General</label>
                        <input type="text" id="generalSearchFilter" class="filter-select" placeholder="Buscar en todos los campos...">
                    </div>

                    <!-- Filtro por tipo de organización -->
                    <div class="form-group">
                        <label class="form-label">Tipo de Organización</label>
                        <select id="tipoOrganizacionFilter" class="filter-select">
                            <option value="">Todos los tipos</option>
                        </select>
                    </div>

                    <!-- Filtro por organización (palabras clave de siglas) -->
                    <div class="form-group">
                        <label class="form-label">Organización</label>
                        <select id="organizacionFilter" class="filter-select">
                            <option value="">Todas las organizaciones</option>
                        </select>
                    </div>

                    <!-- Filtro de espacio de coordinación -->
                    <div class="form-group">
                        <label class="form-label">Grupo de Coordinación</label>
                        <select id="espacioFilter" class="filter-select">
                            <option value="">Todos los grupos</option>
                        </select>
                    </div>

                    <!-- Filtro de municipios -->
                    <div class="form-group">
                        <label class="form-label">Municipio</label>
                        <select id="municipiosFilter" class="filter-select">
                            <option value="">Todos los municipios</option>
                        </select>
                    </div>
                </div>
                
<div class="filter-section">
    <h4 class="filter-title"><i class="fas fa-th"></i> Sectores/Clústeres</h4>
    <div class="icon-grid" id="sectorsGrid"></div>
</div>

<!-- Sección de Grupos Creados -->
<div class="filter-section">
    <h4 class="filter-title"><i class="fas fa-users"></i> Otros Grupos</h4>
    <div id="groupsFilterContainer">
        <!-- Los grupos se cargarán aquí dinámicamente -->
    </div>
</div>

<button class="btn btn-secondary btn-block" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> Limpiar Filtros
                </button>
            </aside>

            <main class="main-content">
                <section class="kpi-section">
                    <h2 style="color: var(--ocha-dark-gray); margin-bottom: 1rem;">
                        <i class="fas fa-chart-line"></i> Cifras Clave
                    </h2>
                    <div class="kpi-grid" id="kpiGrid"></div>
                </section>

                <section class="table-container">
                    <div class="table-header">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input" placeholder="Buscar por organización, punto focal, email, teléfono...">
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showAddContactModal()">
                                <i class="fas fa-user-plus"></i> <span class="btn-text">Nuevo</span>
                            </button>
                            <button class="btn btn-success" onclick="exportExcel()">
                                <i class="fas fa-file-excel"></i> <span class="btn-text">Excel</span>
                            </button>
                            <button class="btn btn-info" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> <span class="btn-text">PDF</span>
                            </button>
                            <input type="file" id="importFile" accept=".xlsx,.csv,.txt" style="display: none;" onchange="importContactsFromFile(event)">
                            <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
                                <i class="fas fa-upload"></i> <span class="btn-text">Importar</span>
                            </button>
			<button class="btn btn-info" onclick="showNewUserMagicLinkModal()">
    <i class="fas fa-link"></i> <span class="btn-text">Enlace Público</span>
</button>
                            <button class="btn btn-primary" onclick="showGroupModal()" title="Gestionar grupos: crear, editar y administrar miembros">
                                <i class="fas fa-users-cog"></i> <span class="btn-text">Gestionar Grupos</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Selection Controls -->
                    <div id="selectionControls" class="selection-controls">
                        <div class="selection-info" id="selectionInfo">0 contactos seleccionados</div>
                        <div class="selection-actions">
                            <button class="btn btn-primary btn-sm" onclick="createGroupFromSelection()">
                                <i class="fas fa-users"></i> Crear Grupo
                            </button>
                            <button class="btn btn-info btn-sm" onclick="sendEmailToSelection()">
                                <i class="fas fa-envelope"></i> Enviar Correo
                            </button>
                            <button class="btn btn-success btn-sm" onclick="sendWhatsAppToSelection()">
                                <i class="fab fa-whatsapp"></i> WhatsApp Grupal
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
                                <i class="fas fa-times"></i> Limpiar Selección
                            </button>
                        </div>
                    </div>
                    
                    <div id="appStatusMessage" class="status-message"></div>
                    
                    <div class="table-wrapper">
                        <table class="contacts-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" class="contact-checkbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th onclick="sortTable('organizacion')">
                                        Organización <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th onclick="sortTable('siglas')">
                                        Siglas <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th onclick="sortTable('punto_focal')">
                                        Punto Focal <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th onclick="sortTable('cargo')">
                                        Cargo <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th onclick="sortTable('email')">
                                        Email <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th onclick="sortTable('espacio_coordinacion')">
                                        Espacio <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTableBody"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>

        <!-- Footer reorganizado por cobertura -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>OCHA Global</h4>
                    <p><a href="https://www.unocha.org" target="_blank">OCHA Worldwide</a></p>
                    <p><a href="https://reliefweb.int" target="_blank">ReliefWeb</a></p>
                    <p><a href="https://www.humanitarianresponse.info" target="_blank">HumanitarianResponse.info</a></p>
                    <p><a href="https://fts.unocha.org" target="_blank">Financial Tracking Service</a></p>
                </div>
                <div class="footer-section">
                    <h4>OCHA Venezuela</h4>
                    <p><a href="https://reliefweb.int/country/ven" target="_blank">ReliefWeb Venezuela</a></p>
                    <p><a href="https://www.humanitarianresponse.info/es/operations/venezuela" target="_blank">Portal Humanitario Venezuela</a></p>
                    <p><a href="https://venezuela.un.org" target="_blank">ONU Venezuela</a></p>
                </div>
                <div class="footer-section">
                    <h4>Sub Oficina OCHA Maracaibo</h4>
                    <p>Coordinación de Asuntos Humanitarios</p>
                    <p>Maracaibo, Estado Zulia, Venezuela</p>
                    <p><a href="https://response.reliefweb.int/venezuela/cct-maracaibo" target="_blank">Portal Sub Oficina Maracaibo</a></p>
                    <p><i class="fas fa-envelope"></i> <a href="mailto:jhozman.camacho@un.org" class="mailto-link">jhozman.camacho@un.org</a></p>
                </div>
            </div>
        </footer>
    </div>

    <!-- View Contact Modal -->
    <div id="viewContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalles del Contacto</h3>
                <button class="modal-close" onclick="closeViewContactModal()">&times;</button>
            </div>
            <div class="modal-body" id="viewContactBody">
                <!-- Contact details will be injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewContactModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content qr-modal">
            <div class="modal-header">
                <h3 class="modal-title">Código QR - Actualización de Contacto</h3>
                <button class="modal-close" onclick="closeQRModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <h4 style="color: var(--color-ochablue); margin-bottom: 1rem;">
                        <span id="qrContactName"></span>
                    </h4>
                    <div class="qr-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Instrucciones:</strong> Escanea este código QR para acceder directamente al formulario de actualización de este contacto.
                    </div>
                    <div id="qrcode" class="qr-code"></div>
                    <div class="qr-info">
                        <i class="fas fa-mobile-alt"></i>
                        El código QR abrirá un enlace seguro donde el contacto podrá actualizar su información directamente.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
			<button type="button" class="btn btn-primary" onclick="downloadQR()">
                    <i class="fas fa-download"></i> Descargar QR
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeQRModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Contact Modal (Add/Edit) -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nuevo Contacto</h3>
                <button class="modal-close" onclick="closeContactModal()">&times;</button>
            </div>
            <form id="contactForm">
                <div class="modal-body">
                    <input type="hidden" id="contactId">
                    
                    <h4 style="color: var(--color-ochablue); margin-bottom: 1rem;">
                        <i class="fas fa-user"></i> Información Personal
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Organización *</label>
                            <input type="text" id="organizacion" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Siglas</label>
                            <input type="text" id="siglas" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Organización</label>
                            <select id="tipo_organizacion" class="form-control">
                                <option value="">Seleccionar tipo</option>
                                <option value="ONG Nacional">ONG Nacional</option>
								<option value="ONG Local">ONG Local</option>
                                <option value="ONG Internacional">ONG Internacional</option>
                                <option value="AFP Naciones Unidas">AFP Naciones Unidas</option>
                                <option value="Gobierno Local">Gobierno Local</option>
                                <option value="Gobierno Nacional">Gobierno Nacional</option>
                                <option value="Organización Religiosa">Organización Religiosa</option>
                                <option value="Sector Privado">Sector Privado</option>
                                <option value="Academia">Academia</option>
                                <option value="Red/Coalición">Red/Coalición</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Punto Focal *</label>
                            <input type="text" id="punto_focal" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cargo</label>
                            <input type="text" id="cargo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Correo Electrónico *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" id="Teléfono" class="form-control" placeholder="+58 414-1234567">
                        </div>
                        <div class="form-group form-grid-full">
                            <label class="form-label"><i class="fas fa-map-location-dot"></i> Grupo de Coordinación</label>
                            <div class="multi-select-container">
                                <div class="multi-select-list" id="espaciosMultiSelect"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--color-ochablue); margin: 1.5rem 0 1rem;">
                        <i class="fas fa-th"></i> Sectores
                    </h4>
                    <div class="multi-select-container">
                        <div class="multi-select-list" id="sectoresMultiSelect"></div>
                    </div>
                    
                    <h4 style="color: var(--color-ochablue); margin: 1.5rem 0 1rem;">
                        <i class="fas fa-map-marker-alt"></i> Municipios
                    </h4>
                    <div class="multi-select-container">
                        <div class="multi-select-list" id="municipiosMultiSelect"></div>
                    </div>
                    
                    <h4 style="color: var(--color-ochablue); margin: 1.5rem 0 1rem;">
                        <i class="fas fa-check-circle"></i> Participación
                    </h4>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="reporta_345w">
                            <label for="reporta_345w">Reporta en el 345W</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="socio_implementador">
                            <label for="socio_implementador">Socio Implementador</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="organizacion_lider">
                            <label for="organizacion_lider">Organización Líder</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="participacion_flc">
                            <label for="participacion_flc">Participación FLC</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeContactModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirmación de Administrador</h3>
                <button class="modal-close" onclick="closeAdminPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-notice">
                    <i class="fas fa-shield-alt"></i>
                    <strong>Seguridad:</strong> Esta acción requiere privilegios de administrador para crear grupos de contactos.
                </div>
                <p id="adminActionMessage" style="margin-bottom: 1rem;"></p>
                <div class="admin-input">
                    <label class="form-label">Clave de Administrador:</label>
                    <div class="password-container">
                        <input type="password" id="adminPassword" class="form-control" placeholder="Ingrese la clave de administrador">
                        <button type="button" class="password-toggle" onclick="togglePassword('adminPassword')">
                            <i class="fas fa-eye" id="adminPasswordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div id="adminPasswordError" class="status-message status-error" style="margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAdminPasswordModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmAdminAction()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal de Confirmación Simple para Eliminar Contacto -->
    <div id="deleteContactModal" class="modal">
        <div class="modal-content admin-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-circle" style="color: var(--ocha-red);"></i>
                    Confirmar Eliminación
                </h3>
                <button class="modal-close" onclick="closeDeleteContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-notice" style="background-color: #fff3cd; border-left: 4px solid var(--color-ochayellow);">
                    <i class="fas fa-info-circle" style="color: #856404;"></i>
                    <strong>¿Está seguro?</strong> Esta acción eliminará permanentemente el contacto y no se puede deshacer.
                </div>

                <div id="deleteContactInfo" style="background: var(--ocha-light-blue); border-radius: 8px; padding: 1.25rem; margin: 1.5rem 0; border-left: 4px solid var(--color-ochablue);">
                    <!-- Información del contacto se cargará aquí -->
                </div>

                <div id="deleteContactModalMessage" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteContactModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteContact()">
                    <i class="fas fa-trash-alt"></i> Sí, Eliminar
                </button>
            </div>
        </div>
    </div>

<!-- Modal antiguo de edición de grupos ELIMINADO - Ahora se usa el modal unificado groupModal -->
<!-- New User Magic Link Modal -->
<div id="newUserMagicLinkModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
<h3 class="modal-title">
    <i class="fas fa-link"></i> Enlace Público de Registro
</h3>
            <button class="modal-close" onclick="closeNewUserMagicLinkModal()">&times;</button>
        </div>
        <div class="modal-body">
<div class="email-notice">
    <i class="fas fa-info-circle"></i>
    <strong>Enlace público:</strong> Genere un enlace que cualquier persona puede usar para registrarse como nuevo contacto en el sistema.
</div>

<div class="form-group">
    <label class="form-label">Descripción del enlace (opcional)</label>
    <input type="text" id="linkDescription" class="form-control" placeholder="Ej: Registro para organizaciones del sector salud">
</div>
            
            <div id="newUserLinkResult" style="display: none; margin-top: 1.5rem;">
                <h5 style="color: var(--color-ochablue); margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i> Enlace Generado
                </h5>
                <div style="background: var(--ocha-light-blue); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin-bottom: 0.5rem;"><strong>Para:</strong> <span id="generatedForEmail"></span></p>
                    <textarea id="generatedMagicLink" class="form-control" rows="3" readonly style="font-family: monospace; font-size: 0.85rem;"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="copyNewUserLink()">
                        <i class="fas fa-copy"></i> Copiar Enlace
                    </button>
                    <button class="btn btn-success" onclick="sendNewUserEmail()">
                        <i class="fas fa-envelope"></i> Enviar por Correo
                    </button>
                    <button class="btn btn-warning" onclick="showNewUserQR()">
                        <i class="fas fa-qrcode"></i> Generar QR
                    </button>
                </div>
                
                <div id="newUserQRContainer" style="display: none; text-align: center; margin-top: 1rem;">
                    <div id="newUserQRCode" style="margin: 1rem 0;"></div>
                    <button class="btn btn-secondary" onclick="downloadNewUserQR()">
                        <i class="fas fa-download"></i> Descargar QR
                    </button>
                </div>
            </div>
            
            <div id="newUserModalMessage" class="status-message"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeNewUserMagicLinkModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="generateNewUserMagicLink()">
                <i class="fas fa-magic"></i> Generar Enlace
            </button>
        </div>
    </div>
</div>
<!-- Delete Group Confirmation Modal -->
<div id="deleteGroupModal" class="modal">
    <div class="modal-content admin-modal">
        <div class="modal-header">
            <h3 class="modal-title">Confirmar Eliminación</h3>
            <button class="modal-close" onclick="closeDeleteGroupModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="deleteGroupId">
            
            <div class="email-notice" style="background: #fff3cd; border-left: 4px solid var(--color-ochayellow);">
                <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                <strong>¿Desea eliminar este grupo?</strong>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem;">
                    Los contactos asociados <strong>NO se borrarán</strong>, solo quedarán sin este grupo asignado.
                    Esta acción no se puede deshacer.
                </p>
            </div>
            
            <div style="margin: 1.5rem 0;">
                <p><strong>Grupo a eliminar:</strong></p>
                <div id="deleteGroupInfo" style="background: var(--ocha-light-blue); border-radius: 6px; padding: 1rem; margin: 1rem 0;">
                    <!-- Información del grupo se cargará aquí -->
                </div>
            </div>
            
            <div id="deleteGroupModalMessage" class="status-message"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteGroupModal()">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteGroup()">
                <i class="fas fa-trash"></i> Eliminar Grupo
            </button>
        </div>
    </div>
</div>
    <!-- NUEVO: Modal de Gestión Avanzada de Grupos (Dos Niveles) -->
    <div id="groupModal" class="modal">
        <div class="modal-content admin-modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="groupModalTitle">
                    <i class="fas fa-users"></i> Gestión de Grupos
                </h3>
                <button class="modal-close" onclick="closeGroupModal()">&times;</button>
            </div>
            <div class="modal-body">

                <!-- NIVEL 1: LISTA DE GRUPOS -->
                <div id="groupsListView" class="groups-view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h5 style="margin: 0; color: var(--color-ochablue);">
                            <i class="fas fa-list"></i> Grupos Existentes
                        </h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreateGroupView()">
                            <i class="fas fa-plus"></i> Crear Nuevo Grupo
                        </button>
                    </div>

                    <div id="groupsListContainer" style="max-height: 500px; overflow-y: auto;">
                        <!-- Grupos se cargarán aquí dinámicamente -->
                    </div>

                    <div id="noGroupsMessage" style="text-align: center; padding: 3rem; color: var(--color-ochagrey); display: none;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="margin: 0;">No hay grupos creados aún.</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Crea tu primer grupo para organizar contactos.</p>
                    </div>
                </div>

                <!-- NIVEL 2: EDICIÓN/CREACIÓN DE GRUPO -->
                <div id="groupEditView" class="groups-view" style="display: none;">
                    <button class="btn btn-secondary btn-sm" onclick="showGroupsListView()" style="margin-bottom: 1rem;">
                        <i class="fas fa-arrow-left"></i> Volver a la lista
                    </button>

                    <input type="hidden" id="editingGroupId" value="">

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Nombre del Grupo *
                        </label>
                        <input type="text" id="editGroupNameInput" class="form-control"
                               placeholder="Ej: Coordinadores Sector Salud" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i> Descripción
                        </label>
                        <textarea id="editGroupDescInput" class="form-control" rows="2"
                                  placeholder="Descripción del propósito del grupo (opcional)"></textarea>
                    </div>

                    <div style="border-top: 2px solid var(--ocha-light-gray); padding-top: 1.5rem; margin-top: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h6 style="margin: 0; color: var(--color-ochablue);">
                                <i class="fas fa-user-friends"></i> Miembros del Grupo
                            </h6>
                            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="memberSearchInput" class="form-control"
                                       placeholder="Buscar contacto..."
                                       style="width: 200px; padding: 0.4rem 0.8rem; font-size: 0.9rem;"
                                       oninput="filterMembersList()">
                                <button class="btn btn-sm btn-success" onclick="toggleOnlyMembers()" title="Seleccionar solo los miembros actuales del grupo">
                                    <i class="fas fa-user-check"></i> Miembros
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="toggleOnlyNonMembers()" title="Seleccionar solo los que NO son miembros">
                                    <i class="fas fa-user-plus"></i> No Miembros
                                </button>
                                <button class="btn btn-sm btn-info" onclick="toggleAllMembers(true)" title="Seleccionar todos los contactos">
                                    <i class="fas fa-check-double"></i> Todos
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleAllMembers(false)" title="Deseleccionar todos">
                                    <i class="fas fa-times"></i> Ninguno
                                </button>
                            </div>
                        </div>

                        <div id="membersList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #fafafa;">
                            <!-- Lista de contactos con checkboxes se cargará aquí -->
                        </div>

                        <div id="membersCount" style="margin-top: 1rem; padding: 0.75rem; background: var(--ocha-light-blue); border-radius: 6px; text-align: center; font-weight: 600; color: var(--color-ochablue);">
                            <i class="fas fa-users"></i> 0 miembros seleccionados
                        </div>
                    </div>

                    <div id="groupEditMessage" class="status-message" style="margin-top: 1rem;"></div>
                </div>

                <div id="groupModalMessage" class="status-message"></div>
            </div>

            <div class="modal-footer" id="groupModalFooter">
                <!-- Botones dinámicos según la vista activa -->
                <button type="button" class="btn btn-secondary" onclick="closeGroupModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
const SUPABASE_URL = 'https://gvobuytrtqxyvognivdt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2b2J1eXRydHF4eXZvZ25pdmR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNDczMTQsImV4cCI6MjA3MDYyMzMxNH0.34oUejp5IwN5vfFXSEPoJRZbFDv7b2aWHpDuE1pV1nE';
const DISABLE_AUTH = true; // Modo lectura sin autenticación
let viewerAccessAllowed = false; // Controla acceso en modo sin login (pedir clave al inicio)
const ALLOWED_VIEWER_PASSWORDS = ['laura', 'jhozman', 'enrique', 'oficial falcón', 'oficial falcon'];
if (DISABLE_AUTH) {
    document.documentElement.classList.add('no-auth', 'access-locked');
}
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
auth: {
        persistSession: true,
        storage: window.localStorage,
        storageKey: 'ocha-maracaibo-auth',
        autoRefreshToken: true,
        detectSessionInUrl: true
    }
});

        // Admin Configuration
        const ADMIN_PASSWORD = 'coordinacion123';
        const GROUP_PASSWORD = 'coordinacion123';

        // Global Variables
        let currentUser = null;
        let contacts = [];
        let filteredContacts = [];
        let selectedContacts = new Set();
let activeFilters = { 
    search: '', 
    generalSearch: '',
    tipoOrganizacion: '',
    organizacion: '',
    espacio: '', 
    sectores: [], 
    municipios: [],
    selectedGroup: null
};
        let appInitialized = false;
        let contactChangesChannel = null;
        let sortField = 'organizacion';
        let sortDirection = 'asc';
        let pendingDeleteId = null;
        let pendingAdminAction = null;
        let currentQRContactId = null;
        let savedGroups = []; // Array para almacenar grupos creados
let currentEditingGroup = null;
let currentDeletingGroup = null;
        // Password toggle function
        function togglePassword(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const toggleIcon = document.getElementById(fieldId + 'ToggleIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Data lists actualizados con Coordinación
        const sectoresList = [
            'Agua, saneamiento e higiene',
            'Alojamiento, energía y enseres',
            'Coordinación',
            'Educación',
            'Nutrición',
            'Protección General',
            'Protección Niños, Niñas, Adolescentes',
            'Protección Violencia de Género',
            'Salud',
            'Seguridad alimentaria'
        ];

        const espaciosList = [
            'Foro Local de Coordinación Zulia',
            'Foro Local de Coordinación Falcón',
            'Grupo de Coordinación Sur del Lago',
            'Grupo de Coordinación Trujillo',
            'Grupo de Coordinación Lara'
        ];

        const municipiosList = [
            'Almirante Padilla', 'Andrés Eloy Blanco', 'Baralt', 'Boconó', 'Bolívar', 'Cabimas',
            'Cacique Manaure', 'Candelaria', 'Carache', 'Carirubana', 'Catatumbo',
            'Colina', 'Colón', 'Crespo', 'Dabajuro', 'Escuque', 'Falcón', 'Federación', 'Francisco Javier Pulgar',
            'Indígena Bolivariano Guajira', 'Iribarren', 'Jesus Enrique Lossada', 'Jesus Maria Semprum',
            'Jiménez', 'Juan Vicente Campo Elías', 'La Cañada De Urdaneta', 'La Ceiba', 'Lagunillas',
            'Los Taques', 'Machiques De Perijá', 'Mara', 'Maracaibo', 'Mauroa', 'Miranda',
            'Monseñor Iturriza', 'Morán', 'Palavecino', 'Palmasola', 'Pampanito', 'Pampán',
            'Petit', 'Píritu', 'Rafael Rangel', 'Rosario De Perijá', 'San Francisco',
            'San Rafael De Carvajal', 'Santa Rita', 'Silva', 'Simón Planas', 'Sucre',
            'Tocópero', 'Torres', 'Trujillo', 'Urdaneta', 'Urumaco', 'Valera',
            'Valmore Rodríguez', 'Zamora'
        ];

        const tiposOrganizacion = [
            'ONG Nacional', 'ONG Internacional','ONG Local', 'AFP Naciones Unidas', 'Gobierno Local', 
            'Gobierno Nacional', 'Organización Religiosa', 'Sector Privado', 
            'Academia', 'Red/Coalición', 'Otro'
        ];

        // Sector icons mapping - todos en color OCHA blue
        const sectorIcons = {
            'Agua, saneamiento e higiene': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzlkXC80MzY2OTIwXC83MWE1OTcyMzkyYTJkM2VlNDgxNmQ1ODU0MGNmNTliYS0xNTkxNzIxMTgyLnN2ZyJ9:frontify:MgH6UY5xqyfKx77ec3VRFtR1lOv93RJDs8MqbwFkJpM?width=64',
            'Alojamiento, energía y enseres': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2NmXC80MzY2ODEyXC8xZTI5NzQzMzcyOTE0YjE2MDkxNTI0N2NkZGMwY2E3NC0xNTkxNzE4OTIxLnN2ZyJ9:frontify:FUBxqK8yAh-cPqjcmhGA4pR442WpMZP8wrc1C9PJZn8?width=64', 
            'Coordinación': 'https://images4.imagebam.com/ef/ae/80/ME150QRY_o.jpg',
            'Educación': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzJjXC80MzY0NjkwXC8xYTIwZTMxZTMzOTEwY2U3YTA4Yjg5ODVhOGU5Mjg0My0xNTkxNjkzNjA1LnN2ZyJ9:frontify:90NzWxvX_2V0BDPOGueYpIZfuSZvJfOer4Pkvq4dHBA?width=64',
            'Protección General': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2EyXC80MzY1OTYwXC8zYjFiMDY2MTAzYjIyMWY0MTI4YTVkNzkxYmRjOTE3YS0xNTkxNzA4MzI2LnN2ZyJ9:frontify:7lTtjGE2P2Nbz_525sMoZikLkHSh9tegag19Prx_SZc?width=64',
            'Protección Niños, Niñas, Adolescentes': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2EyXC80MzY1OTYwXC8zYjFiMDY2MTAzYjIyMWY0MTI4YTVkNzkxYmRjOTE3YS0xNTkxNzA4MzI2LnN2ZyJ9:frontify:7lTtjGE2P2Nbz_525sMoZikLkHSh9tegag19Prx_SZc?width=64',
            'Protección Violencia de Género': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2EyXC80MzY1OTYwXC8zYjFiMDY2MTAzYjIyMWY0MTI4YTVkNzkxYmRjOTE3YS0xNTkxNzA4MzI2LnN2ZyJ9:frontify:7lTtjGE2P2Nbz_525sMoZikLkHSh9tegag19Prx_SZc?width=64',
            'Salud': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzQwXC80MzY1MDA0XC9jNDk5OWE4ZDk2ZDE1YjZhNzIxMTQ5ZWU4YTFiMTkwMy0xNTkxNzAxMjUzLnN2ZyJ9:frontify:R0CU010gVeFON_MaMY38IILJz2LXMajqem4P1TiGwQk?width=64',
            'Seguridad alimentaria': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcL2I0XC80MzY0Nzc1XC8xYjhhNmIxNzZlZTQ4MThjZjJjOGE5NDQyN2FjMjNjYi0xNTkxNjk0MjY5LnN2ZyJ9:frontify:tXhekXovZmafEC1xe1vMSYzRz4aiC23x9HTHlGsrz4U?width=64',
            'Nutrición': 'https://cdn-assets-cloud.frontify.com/s3/frontify-cloud-files-us/eyJwYXRoIjoiZnJvbnRpZnlcL2FjY291bnRzXC84MVwvMTY2NjYzXC9wcm9qZWN0c1wvMjUxMDIzXC9hc3NldHNcLzQzXC80MzY1NzM1XC82ODU2MWExNDAzMzc0NzBjNDE5MGFmYWY5NTFkNzU4Yi0xNTkxNzA2NjI1LnN2ZyJ9:frontify:3rsyLJgQXbU3Y015aKrjd1ohrB4PI_KPd723_KhjCWA?width=64'
        };

        // --- FUNCIONES MAGIC LINKS ---
        function generateSecureToken() {
            if (window.crypto && window.crypto.getRandomValues) {
                const array = new Uint8Array(32);
                window.crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            } else {
                console.warn("Usando generación de token de respaldo.");
                let token = '';
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                for (let i = 0; i < 64; i++) {
                    token += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return token;
            }
        }

        async function saveMagicLinkToken(contactId, email, token) {
            try {
                const expiresAt = new Date();
                expiresAt.setHours(expiresAt.getHours() + 2);
                
                const { error } = await sb
                    .from('magic_links')
                    .upsert({
                        contact_id: contactId,
                        email: email,
                        token: token,
                        expires_at: expiresAt.toISOString(),
                        used: false
                    });
                    
                if (error) {
                    console.error('Error guardando token magic link:', error);
                    throw error;
                }
                console.log(`Token magic link guardado para ${email} (ID: ${contactId})`);
            } catch (error) {
                console.error('Error en saveMagicLinkToken:', error);
                throw error;
            }
        }

        function getAppConfig() {
            const config = {
                baseUrl: 'https://ochavenezuela.github.io/DirectorioSubOficinaOCHAMaracaibo',
                isGithubPages: true,
                isDevelopment: false,
                isProduction: true
            };
            
            console.log('🌍 Configuración GitHub Pages:', config.baseUrl);
            return config;
        }

        async function generateRealMagicLink(email, contactId) {
            try {
                const appConfig = getAppConfig();
                const redirectUrl = `https://ochavenezuela.github.io/DirectorioSubOficinaOCHAMaracaibo/update-contact.html`;
                
                console.log('🔗 Generando magic link:', {
                    email,
                    contactId,
                    redirectUrl,
                    environment: appConfig
                });

                const magicLinkToken = generateSecureToken();
                await saveMagicLinkToken(contactId, email, magicLinkToken);
                
                const magicLink = `${redirectUrl}?token=${magicLinkToken}&id=${contactId}`;
                
                console.log("✅ Magic Link generado:", magicLink);
                console.log("📏 Longitud del enlace:", magicLink.length);
                return magicLink;

            } catch (error) {
                console.error('❌ Error generando magic link:', error);
                return `https://ochavenezuela.github.io/update-contact.html?id=${contactId}&email=${encodeURIComponent(email)}`;
            }
        }

        // Initialize Application
        async function initializeApp() {
            if (appInitialized && currentUser) return;
            if (!currentUser) return;
            
            console.log("Inicializando datos de la aplicación...");
            
            setupEventListenersApp();
            setupFilters();
            setupMultiSelectLists();
            await loadContacts();
            await loadGroups();
            setupRealtimeSubscription();
            
            appInitialized = true;
        }

        function setupRealtimeSubscription() {
            if (contactChangesChannel) {
                try {
                    sb.removeChannel(contactChangesChannel);
                } catch(e) {
                    console.warn("Error eliminando canal anterior:", e);
                }
            }
            
            contactChangesChannel = sb.channel('contacts-changes');
            contactChangesChannel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'contacts' }, handleRealtimeUpdate)
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Suscrito al canal contacts-changes!');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('Error de suscripción en el canal contacts-changes');
                    } else if (status === 'TIMED_OUT') {
                        console.warn('Tiempo de espera agotado en el canal contacts-changes');
                    }
                });
        }
function handleRealtimeUpdate(payload) {
    console.log('Actualización en tiempo real:', payload);
    let changed = false;
    
    if (payload.eventType === 'INSERT') {
        const existing = contacts.find(c => c.id === payload.new.id);
        if (!existing) {
            contacts.push(payload.new);
            changed = true;
        }
    } else if (payload.eventType === 'UPDATE') {
        const index = contacts.findIndex(c => c.id === payload.new.id);
        if (index > -1) {
            contacts[index] = {...contacts[index], ...payload.new};
            changed = true;
        } else {
            contacts.push(payload.new);
            changed = true;
        }
    } else if (payload.eventType === 'DELETE') {
        const oldLength = contacts.length;
        contacts = contacts.filter(c => c.id !== payload.old.id);
        if (contacts.length !== oldLength) changed = true;
    }
    
if (changed) {
    setupDynamicFilters();
    applyFilters();
}
}

function setupFilters() {
    // Configurar filtros dinámicos primero
    setupDynamicFilters();
    
    // Filtro de sectores (Grilla de iconos en la barra lateral) - SIEMPRE LOS 10 FIJOS
    setupSectorIcons();
    
    // Configurar filtro de grupos
    setupGroupsFilter();
}

function setupSectorIcons() {
    const sectorsGrid = document.getElementById('sectorsGrid');
    sectorsGrid.innerHTML = '';
    
    // Usar solo los sectores predefinidos (10 sectores fijos)
    sectoresList.forEach(sector => {
        const div = document.createElement('div');
        div.className = 'icon-item';
        div.dataset.sector = sector;
        div.onclick = () => toggleSectorFilter(sector);
        
        const iconUrl = sectorIcons[sector] || sectorIcons['Coordinación'];
        div.innerHTML = `
            <img src="${iconUrl}" alt="${sector}" class="sector-icon" onerror="this.src='${sectorIcons['Coordinación']}'; this.onerror=null;">
            <div class="sector-name">${sector.split(' ').slice(0, 2).join(' ')}</div>
        `;
        sectorsGrid.appendChild(div);
    });
}

        function setupDynamicFilters() {
            // Filtro de tipos de organización
            const tipoOrganizacionFilter = document.getElementById('tipoOrganizacionFilter');
            tipoOrganizacionFilter.innerHTML = '<option value="">Todos los tipos</option>';
            tiposOrganizacion.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                tipoOrganizacionFilter.appendChild(option);
            });

            // Filtro de organizaciones (basado en siglas existentes)
            const organizacionFilter = document.getElementById('organizacionFilter');
            organizacionFilter.innerHTML = '<option value="">Todas las organizaciones</option>';
            const organizaciones = [...new Set(contacts.map(c => c.siglas || c.organizacion).filter(Boolean))].sort();
            organizaciones.forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org;
                organizacionFilter.appendChild(option);
            });

            // Filtro de espacios - Divide valores múltiples separados por coma
            const espacioFilter = document.getElementById('espacioFilter');
            espacioFilter.innerHTML = '<option value="">Todos los grupos</option>';

            // Dividir cada campo espacio_coordinacion en valores individuales
            const availableSpaces = contacts.length > 0
                ? [...new Set(
                    contacts
                        .map(c => getEspaciosAsArray(c.espacio_coordinacion))  // Divide por comas
                        .flat()  // Aplasta array de arrays a un solo array
                        .filter(Boolean)  // Elimina valores vacíos
                  )].sort()
                : espaciosList;

            availableSpaces.forEach(espacio => {
                const option = document.createElement('option');
                option.value = espacio;
                option.textContent = espacio;
                espacioFilter.appendChild(option);
            });

            // Filtro de municipios
            const municipiosFilter = document.getElementById('municipiosFilter');
            municipiosFilter.innerHTML = '<option value="">Todos los municipios</option>';
            municipiosList.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                municipiosFilter.appendChild(option);
            });
        }

        function setupMultiSelectLists() {
            // Sectores para el formulario de contacto
            const sectoresContainer = document.getElementById('sectoresMultiSelect');
            sectoresContainer.innerHTML = '';
            sectoresList.forEach(sector => {
                const div = document.createElement('div');
                div.className = 'multi-select-item';
                div.innerHTML = `
                    <input type="checkbox" id="sector_${sector.replace(/[^a-zA-Z0-9]/g, '_')}" value="${sector}">
                    <label for="sector_${sector.replace(/[^a-zA-Z0-9]/g, '_')}">${sector}</label>
                `;
                sectoresContainer.appendChild(div);
            });

            // Municipios para el formulario de contacto
            const municipiosContainer = document.getElementById('municipiosMultiSelect');
            municipiosContainer.innerHTML = '';
            municipiosList.forEach(municipio => {
                const div = document.createElement('div');
                div.className = 'multi-select-item';
                div.innerHTML = `
                    <input type="checkbox" id="municipio_${municipio.replace(/[^a-zA-Z0-9]/g, '_')}" value="${municipio}">
                    <label for="municipio_${municipio.replace(/[^a-zA-Z0-9]/g, '_')}">${municipio}</label>
                `;
                municipiosContainer.appendChild(div);
            });

            // Espacios para el formulario de contacto
            const espaciosContainer = document.getElementById('espaciosMultiSelect');
            espaciosContainer.innerHTML = '';
            espaciosList.forEach(espacio => {
                const div = document.createElement('div');
                div.className = 'multi-select-item';
                div.innerHTML = `
                    <input type="checkbox" id="espacio_${espacio.replace(/[^a-zA-Z0-9]/g, '_')}" value="${espacio}">
					<label for="espacio_${espacio.replace(/[^a-zA-Z0-9]/g, '_')}">${espacio}</label>
                `;
                espaciosContainer.appendChild(div);
            });
        }

        function toggleSectorFilter(sector) {
            const element = document.querySelector(`[data-sector="${sector}"]`);
            
            if (activeFilters.sectores.includes(sector)) {
                activeFilters.sectores = activeFilters.sectores.filter(s => s !== sector);
                element.classList.remove('active');
            } else {
                activeFilters.sectores.push(sector);
                element.classList.add('active');
            }
            
            applyFilters();
        }

        function setupAuthEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('passwordResetForm').addEventListener('submit', handlePasswordResetRequest);
            
            document.getElementById('showRegisterLink').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('register'); });
            document.getElementById('showPasswordResetLink').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('reset'); });
            document.getElementById('showLoginFromRegisterLink').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
            document.getElementById('showLoginFromResetLink').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
        }

        function setupEventListenersApp() {
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('generalSearchFilter').addEventListener('input', debounce(handleGeneralSearch, 300));
            document.getElementById('tipoOrganizacionFilter').addEventListener('change', handleTipoOrganizacionFilter);
            document.getElementById('organizacionFilter').addEventListener('change', handleOrganizacionFilter);
            document.getElementById('espacioFilter').addEventListener('change', handleEspacioFilter);
            document.getElementById('municipiosFilter').addEventListener('change', handleMunicipiosFilter);
            document.getElementById('contactForm').addEventListener('submit', handleContactSubmit);
        }

        // Event handlers para los nuevos filtros
        function handleGeneralSearch() {
            activeFilters.generalSearch = document.getElementById('generalSearchFilter').value.toLowerCase();
            applyFilters();
        }

        function handleTipoOrganizacionFilter() {
            activeFilters.tipoOrganizacion = document.getElementById('tipoOrganizacionFilter').value;
            applyFilters();
        }

        function handleOrganizacionFilter() {
            activeFilters.organizacion = document.getElementById('organizacionFilter').value;
            applyFilters();
        }

        function handleMunicipiosFilter() {
            const select = document.getElementById('municipiosFilter');
            activeFilters.municipios = select.value ? [select.value] : [];
            applyFilters();
        }

        // Renderizar contactos con botones de acción mejorados
        function renderContacts() {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron contactos que coincidan con los filtros.</td></tr>';
                return;
            }
            
            filteredContacts.forEach(contact => {
                const tr = document.createElement('tr');
                
                // Formatear teléfono para WhatsApp
                const phoneForWhatsApp = formatPhoneForWhatsApp(contact.Teléfono);
                const whatsappBtn = phoneForWhatsApp ? 
                    `<button class="action-btn action-btn-whatsapp" data-tooltip="WhatsApp" onclick="sendWhatsApp('${phoneForWhatsApp}')">
                        <i class="fab fa-whatsapp"></i>
                    </button>` : '';
                
                tr.innerHTML = `
                    <td><input type="checkbox" class="contact-checkbox" value="${contact.id}" onchange="toggleContactSelection('${contact.id}')"></td>
                    <td>${contact.organizacion || ''}</td>
                    <td>${contact.siglas || ''}</td>
                    <td>${contact.punto_focal || ''}</td>
                    <td>${contact.cargo || ''}</td>
                    <td>
                        ${contact.email || ''}
                        ${contact.email ? `<i class="fas fa-copy copy-icon" title="Copiar email" onclick="copyToClipboard('${contact.email}', this)"></i>` : ''}
                    </td>
                    <td>${contact.espacio_coordinacion || ''}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn action-btn-view" data-tooltip="Ver Detalles" onclick="viewContact('${contact.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn action-btn-edit" data-tooltip="Editar" onclick="editContact('${contact.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn action-btn-qr" data-tooltip="Código QR" onclick="showQRModal('${contact.id}')">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            ${whatsappBtn}
                            <button class="action-btn action-btn-delete" data-tooltip="Eliminar" onclick="deleteContact('${contact.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        // Función WhatsApp para contacto individual
        function sendWhatsApp(phone) {
            if (!phone) {
                showAppMessage('Número de teléfono no disponible', 'warning');
                return;
            }
            
            const message = encodeURIComponent('Mensaje de OCHA Maracaibo:\n\n');
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }

        async function importContactsFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showAppMessage('Procesando archivo...', 'info', false);
            try {
                let jsonData;
                
                if (file.name.endsWith('.txt') || file.name.endsWith('.csv')) {
                    const text = await readFileAsText(file);
                    jsonData = parseCsvText(text);
                } else if (file.name.endsWith('.xlsx')) {
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    jsonData = parseExcelFile(arrayBuffer);
                } else {
                    throw new Error("Formato de archivo no soportado. Use .txt, .csv o .xlsx.");
                }

                if (!jsonData || jsonData.length === 0) {
                    showAppMessage('El archivo importado está vacío o no se pudo leer.', 'error');
                    return;
                }
                console.log("Datos parseados del archivo:", jsonData.slice(0, 3));
                await processAndUpsertContacts(jsonData, 'archivo');
                
            } catch (error) {
                console.error("Error en importContactsFromFile:", error);
                showAppMessage('Error importando contactos desde archivo: ' + error.message, 'error');
            } finally {
                event.target.value = null;
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file, 'UTF-8');
            });
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        function parseCsvText(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(';').map(h => h.replace(/"/g, '').trim());
            const jsonData = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].toLowerCase().startsWith('total')) continue;

                const values = lines[i].split(';');
                const rowObject = {};
                headers.forEach((header, index) => {
                    const value = values[index] ? values[index].trim() : "";
                    rowObject[header] = value;
                });
                jsonData.push(rowObject);
            }
            return jsonData;
        }

        function parseExcelFile(arrayBuffer) {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            if (!firstSheetName) throw new Error("El archivo Excel no contiene hojas.");
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
            return jsonData;
        }

        async function processAndUpsertContacts(jsonData, sourceType) {
            showAppMessage(`Procesando ${jsonData.length} contactos desde ${sourceType}...`, 'info', false);
            
            const contactsToUpsert = jsonData.map(processImportRow).filter(c => c.email);

            if (contactsToUpsert.length === 0) {
                showAppMessage('No se encontraron contactos válidos para importar (se requiere email).', 'error');
                return;
            }

            const chunkSize = 50;
            let importedCount = 0;
            let errorsCount = 0;

            for (let i = 0; i < contactsToUpsert.length; i += chunkSize) {
                const chunk = contactsToUpsert.slice(i, i + chunkSize);
                const { error } = await sb.from('contacts').upsert(chunk, { onConflict: 'email' });

                if (error) {
                    console.error("Error during upsert for chunk:", error);
                    errorsCount += chunk.length;
                } else {
                    importedCount += chunk.length;
                }
                showAppMessage(`Procesando... ${i + chunk.length} de ${contactsToUpsert.length}`, 'info', false);
            }
            
            let finalMessage = `${importedCount} contactos importados/actualizados.`;
            if (errorsCount > 0) {
                finalMessage += ` ${errorsCount} filas no pudieron ser procesadas.`;
            }
            showAppMessage(finalMessage, errorsCount === 0 ? 'success' : 'error');

            await loadContacts();
        }

        function processImportRow(row) {
            const get = (keys) => {
                for (const key of keys) {
                    const foundKey = Object.keys(row).find(k => k.toLowerCase() === key.toLowerCase());
                    if (foundKey && row[foundKey] !== undefined && row[foundKey] !== null) {
                        return String(row[foundKey]).trim();
                    }
                }
                return '';
            };
            const getBool = (keys) => {
                const val = get(keys).toLowerCase();
                return val === 'sí' || val === 's' || val === 'si' || val === 'true' || val === '1' || val === 'yes';
            };

            return {
                organizacion: get(['Organización']),
                siglas: get(['Siglas']),
                punto_focal: get(['Punto Focal', 'Nombre Punto Focal']),
                cargo: get(['Cargo', 'Puesto']),
                email: get(['Email', 'Correo Electrónico']),
                Teléfono: get(['Teléfono', 'Tel']),
                tipo_organizacion: get(['Tipo de Organización', 'Tipo Organización']),
                reporta_345w: getBool(['Reporta en el 345W', '345W Report']),
                socio_implementador: getBool(['Socio Implementador', 'Implementer Partner']),
                organizacion_lider: getBool(['Organización Líder', 'Lead Org']),
                participacion_flc: getBool(['Participación FLC', 'FLC Participation']),
                espacio_coordinacion: get(['Espacio de Coordinación']),
                sectores_concat: get(['Sectores', 'Sectors']),
                municipios_concat: get(['Municipios', 'Municipalities'])
            };
        }

        function exportExcel() {
            const exportData = filteredContacts.map(contact => ({
                'Organización': contact.organizacion,
                'Siglas': contact.siglas,
                'Punto Focal': contact.punto_focal,
                'Cargo': contact.cargo,
                'Email': contact.email,
                'Teléfono': contact.Teléfono,
                'Tipo de Organización': contact.tipo_organizacion,
                'Reporta en el 345W': contact.reporta_345w ? 'Sí' : 'No',
                'Socio Implementador': contact.socio_implementador ? 'Sí' : 'No',
                'Organización Líder': contact.organizacion_lider ? 'Sí' : 'No',
                'Participación FLC': contact.participacion_flc ? 'Sí' : 'No',
                'Espacio de Coordinación': contact.espacio_coordinacion,
                'Sectores': contact.sectores_concat,
                'Municipios': contact.municipios_concat
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Contactos');
            XLSX.writeFile(wb, `contactos_ocha_maracaibo_${new Date().toISOString().split('T')[0]}.xlsx`);
            showAppMessage('Exportación Excel completada exitosamente', 'success');
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const addHeader = (pageNumber = 1) => {
                doc.setFontSize(16);
                doc.setTextColor(0, 114, 188);
                doc.text('Sub Oficina OCHA Maracaibo', doc.internal.pageSize.width / 2, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('Lista de Contactos Humanitarios', doc.internal.pageSize.width / 2, 25, { align: 'center' });
            };

            const addFooter = (pageNumber, totalPages) => {
                const today = new Date().toLocaleDateString('es-ES');
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Fecha: ${today}`, 20, doc.internal.pageSize.height - 10);
                doc.text(`Página ${pageNumber} de ${totalPages}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 10, { align: 'right' });
            };

            const tableData = filteredContacts.map(c => [
                c.organizacion || '', 
                c.siglas || '', 
                c.punto_focal || '', 
                c.cargo || '', 
                c.email || '', 
                c.Teléfono || '', 
                c.tipo_organizacion || '',
                c.espacio_coordinacion || ''
            ]);

            const rowsPerPage = 15;
            const totalPages = Math.ceil(tableData.length / rowsPerPage);

            doc.autoTable({
                head: [['Organización', 'Siglas', 'Punto Focal', 'Cargo', 'Email', 'Teléfono', 'Tipo Org.', 'Espacio']],
                body: tableData,
                startY: 35,
                margin: { top: 35, bottom: 20 },
                headStyles: { 
                    fillColor: [0, 114, 188],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                bodyStyles: { 
                    fontSize: 7,
                    cellPadding: 1.5,
                    valign: 'middle'
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 45 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 30 },
                    7: { cellWidth: 30 }
                },
                didDrawPage: (data) => {
                    addHeader();
                    addFooter(data.pageNumber, totalPages);
                },
                showHead: 'everyPage',
                theme: 'striped'
            });

            doc.save(`contactos_ocha_maracaibo_${new Date().toISOString().split('T')[0]}.pdf`);
            showAppMessage('Exportación PDF completada exitosamente', 'success');
        }

        // Funciones de selección
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox:not(#selectAll)');
            
            if (selectAllCheckbox.checked) {
                contactCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedContacts.add(checkbox.value);
                });
            } else {
                contactCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectedContacts.clear();
            }
            updateSelectionControls();
        }

        function toggleContactSelection(contactId) {
            if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
            } else {
                selectedContacts.add(contactId);
            }
            
            updateSelectAllCheckbox();
            updateSelectionControls();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox:not(#selectAll)');
            const checkedCheckboxes = document.querySelectorAll('.contact-checkbox:not(#selectAll):checked');
            
            if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCheckboxes.length === contactCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

function updateSelectionControls() {
    const selectionControls = document.getElementById('selectionControls');
    const selectionInfo = document.getElementById('selectionInfo');
    
    if (selectedContacts.size > 0) {
        selectionControls.classList.add('active');
        selectionInfo.textContent = `${selectedContacts.size} contacto${selectedContacts.size > 1 ? 's' : ''} seleccionado${selectedContacts.size > 1 ? 's' : ''}`;
        
        // Actualizar los botones dinámicamente si no existen
        updateSelectionButtons();
    } else {
        selectionControls.classList.remove('active');
    }
}

function updateSelectionButtons() {
    const selectionActions = document.querySelector('.selection-actions');
    
    // Verificar si ya existe el botón Magic Links
    if (!document.getElementById('magicLinksBtn')) {
        // Buscar el botón de WhatsApp para insertar antes
        const whatsappBtn = selectionActions.querySelector('button[onclick="sendWhatsAppToSelection()"]');
        
        if (whatsappBtn) {
            const magicLinksBtn = document.createElement('button');
            magicLinksBtn.id = 'magicLinksBtn';
            magicLinksBtn.className = 'btn btn-warning btn-sm';
            magicLinksBtn.onclick = sendMassiveMagicLinks;
            magicLinksBtn.innerHTML = '<i class="fas fa-magic"></i> Magic Links';
            
            // Insertar antes del botón de WhatsApp
            whatsappBtn.parentNode.insertBefore(magicLinksBtn, whatsappBtn);
        }
    }
}

        function clearSelection() {
            selectedContacts.clear();
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            const selectAllCheckbox = document.getElementById('selectAll');
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
            updateSelectionControls();
        }

        // MODIFICADO: Crear grupo directamente sin contraseña
        function createGroupFromSelection() {
            if (selectedContacts.size === 0) {
                showAppMessage('Seleccione al menos un contacto para crear un grupo', 'error');
                return;
            }

            // Abrir modal directamente con contactos pre-seleccionados
            showGroupModal(selectedContacts);
        }

        // NUEVO: Modal de Gestión Avanzada de Grupos - Navegación entre vistas
        function showGroupModal(preselectedContactIds = null) {
            // Si hay contactos pre-seleccionados, abrir en modo creación
            if (preselectedContactIds && preselectedContactIds.size > 0) {
                document.getElementById('groupModal').classList.add('active');
                showCreateGroupViewWithPreselection(Array.from(preselectedContactIds));
            } else {
                // Resetear el modal a la vista de lista
                showGroupsListView();
                // Cargar grupos en la lista
                loadGroupsIntoModal();
                // Mostrar el modal
                document.getElementById('groupModal').classList.add('active');
            }
        }

        // NUEVO: Mostrar vista de creación con contactos pre-seleccionados
        async function showCreateGroupViewWithPreselection(preselectedIds) {
            document.getElementById('groupsListView').style.display = 'none';
            document.getElementById('groupEditView').style.display = 'block';
            document.getElementById('groupModalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Crear Nuevo Grupo';

            // Limpiar formulario
            document.getElementById('editingGroupId').value = '';
            document.getElementById('editGroupNameInput').value = '';
            document.getElementById('editGroupDescInput').value = '';

            // Cargar lista de miembros
            await loadMembersList(null);

            // Pre-seleccionar los contactos
            preselectedIds.forEach(contactId => {
                const checkbox = document.querySelector(`#membersList input[value="${contactId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    toggleMemberCheckbox(checkbox);
                }
            });

            // Actualizar botones del footer
            const footer = document.getElementById('groupModalFooter');
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="showGroupsListView()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveGroupChanges()">
                    <i class="fas fa-save"></i> Crear Grupo
                </button>
            `;

            clearGroupMessages();
        }

        // NUEVO: Mostrar vista de lista de grupos
        function showGroupsListView() {
            document.getElementById('groupsListView').style.display = 'block';
            document.getElementById('groupEditView').style.display = 'none';
            document.getElementById('groupModalTitle').innerHTML = '<i class="fas fa-users"></i> Gestión de Grupos';

            // Actualizar botones del footer
            const footer = document.getElementById('groupModalFooter');
            footer.innerHTML = '<button type="button" class="btn btn-secondary" onclick="closeGroupModal()">Cerrar</button>';

            // Limpiar mensajes
            clearGroupMessages();
        }

        // NUEVO: Cargar grupos en el modal (vista de lista)
        function loadGroupsIntoModal() {
            const container = document.getElementById('groupsListContainer');
            const noGroupsMsg = document.getElementById('noGroupsMessage');

            if (savedGroups.length === 0) {
                container.innerHTML = '';
                noGroupsMsg.style.display = 'block';
                return;
            }

            noGroupsMsg.style.display = 'none';
            container.innerHTML = '';

            savedGroups.forEach((group) => {
                const card = document.createElement('div');
                card.className = 'group-list-card';
                card.innerHTML = `
                    <div class="group-list-card-header">
                        <div style="flex: 1;">
                            <h4 class="group-list-card-title">
                                <i class="fas fa-folder"></i> ${group.name}
                            </h4>
                            <span class="group-list-card-count">
                                <i class="fas fa-users"></i> ${group.contact_ids ? group.contact_ids.length : 0} miembros
                            </span>
                        </div>
                    </div>
                    <div class="group-list-card-description">
                        ${group.description || '<em style="color: #999;">Sin descripción</em>'}
                    </div>
                    <div class="group-list-card-actions">
                        <button class="btn btn-sm btn-primary" onclick="showEditGroupView('${group.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function selectGroup(groupIndex) {
            const group = savedGroups[groupIndex];
            if (!group) return;

            // Mostrar información del grupo seleccionado
            showAppMessage(`Grupo seleccionado: ${group.name} (${group.contacts.length} contactos)`, 'info');

            // Aquí podrías agregar más funcionalidad, como:
            // - Enviar email a todos los contactos del grupo
            // - Editar el grupo
            // - Eliminar el grupo
            // - Exportar lista del grupo
        }

        // ============ NUEVAS FUNCIONES PARA GESTIÓN AVANZADA DE GRUPOS ============

        // NUEVO: Mostrar vista de creación de grupo
        function showCreateGroupView() {
            document.getElementById('groupsListView').style.display = 'none';
            document.getElementById('groupEditView').style.display = 'block';
            document.getElementById('groupModalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Crear Nuevo Grupo';

            // Limpiar formulario
            document.getElementById('editingGroupId').value = '';
            document.getElementById('editGroupNameInput').value = '';
            document.getElementById('editGroupDescInput').value = '';

            // Cargar lista de miembros (ninguno seleccionado)
            loadMembersList(null);

            // Actualizar botones del footer
            const footer = document.getElementById('groupModalFooter');
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="showGroupsListView()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveGroupChanges()">
                    <i class="fas fa-save"></i> Crear Grupo
                </button>
            `;

            clearGroupMessages();
        }

        // NUEVO: Mostrar vista de edición de grupo
        async function showEditGroupView(groupId) {
            const group = savedGroups.find(g => g.id === groupId);
            if (!group) {
                showAppMessage('Grupo no encontrado', 'error');
                return;
            }

            document.getElementById('groupsListView').style.display = 'none';
            document.getElementById('groupEditView').style.display = 'block';
            document.getElementById('groupModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Grupo';

            // Cargar datos del grupo
            document.getElementById('editingGroupId').value = groupId;
            document.getElementById('editGroupNameInput').value = group.name;
            document.getElementById('editGroupDescInput').value = group.description || '';

            // Cargar lista de miembros con los actuales marcados
            await loadMembersList(groupId);

            // Actualizar botones del footer
            const footer = document.getElementById('groupModalFooter');
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="showGroupsListView()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveGroupChanges()">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            `;

            clearGroupMessages();
        }

        // NUEVO: Cargar lista de todos los contactos con checkboxes
        async function loadMembersList(groupId) {
            const container = document.getElementById('membersList');
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--color-ochablue);"></i></div>';

            try {
                console.log(`🔍 Cargando miembros para grupo ID: ${groupId} (tipo: ${typeof groupId})`);

                // Obtener IDs de miembros actuales del grupo
                let currentMemberIds = [];
                if (groupId) {
                    const { data: members, error } = await sb
                        .from('contact_group_members')
                        .select('contact_id')
                        .eq('group_id', groupId);

                    if (error) {
                        console.error('❌ Error obteniendo miembros:', error);
                        throw error;
                    }

                    currentMemberIds = members.map(m => m.contact_id);
                    console.log(`✅ Miembros actuales del grupo:`, currentMemberIds);
                    console.log(`   Tipo de IDs de miembros:`, currentMemberIds.length > 0 ? typeof currentMemberIds[0] : 'N/A');
                }

                // Guardar miembros originales para los botones de selección inteligente
                originalMemberIds = [...currentMemberIds];

                // Crear lista de todos los contactos
                container.innerHTML = '';

                if (contacts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--color-ochagrey); padding: 2rem;">No hay contactos disponibles</p>';
                    return;
                }

                console.log(`📋 Total contactos disponibles: ${contacts.length}`);
                console.log(`   Tipo de IDs de contactos:`, contacts.length > 0 ? typeof contacts[0].id : 'N/A');
                console.log(`   Ejemplo ID contacto:`, contacts.length > 0 ? contacts[0].id : 'N/A');

                let checkedCount = 0;

                contacts.forEach(contact => {
                    // Comparación robusta: convertir ambos a string para comparar
                    const isChecked = currentMemberIds.some(memberId =>
                        String(memberId) === String(contact.id)
                    );

                    if (isChecked) checkedCount++;

                    const checkboxId = `member-${contact.id}`;

                    const item = document.createElement('div');
                    item.className = `member-checkbox-item ${isChecked ? 'checked' : ''}`;
                    item.onclick = function(e) {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = this.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                            toggleMemberCheckbox(checkbox);
                        }
                    };

                    item.innerHTML = `
                        <input type="checkbox" id="${checkboxId}"
                               value="${contact.id}"
                               ${isChecked ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleMemberCheckbox(this)">
                        <label for="${checkboxId}">
                            <div class="member-checkbox-name">${contact.punto_focal || 'Sin nombre'}</div>
                            <div class="member-checkbox-org">
                                <i class="fas fa-building"></i> ${contact.organizacion || 'Sin organización'}
                                ${contact.email ? `<span style="margin-left: 0.5rem;">• ${contact.email}</span>` : ''}
                            </div>
                        </label>
                    `;

                    container.appendChild(item);
                });

                console.log(`✅ ${checkedCount} checkboxes marcados de ${contacts.length} contactos`);

                updateMembersCount();

            } catch (error) {
                console.error('❌ Error cargando miembros:', error);
                container.innerHTML = '<p style="text-align: center; color: var(--ocha-red); padding: 2rem;">Error al cargar contactos</p>';
            }
        }

        // NUEVO: Toggle checkbox de miembro
        function toggleMemberCheckbox(checkbox) {
            const item = checkbox.closest('.member-checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
            updateMembersCount();
        }

        // NUEVO: Actualizar contador de miembros seleccionados
        function updateMembersCount() {
            const checkedBoxes = document.querySelectorAll('#membersList input[type="checkbox"]:checked');
            const count = checkedBoxes.length;
            const countElement = document.getElementById('membersCount');
            countElement.innerHTML = `<i class="fas fa-users"></i> ${count} miembro${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
        }

        // Variable global para rastrear miembros originales
        let originalMemberIds = [];

        // MODIFICADO: Seleccionar/Deseleccionar todos (primero restaura vista completa)
        function toggleAllMembers(select) {
            // Primero, mostrar todos los items
            showAllMembers();

            // Luego seleccionar o deseleccionar
            const checkboxes = document.querySelectorAll('#membersList input[type="checkbox"]');
            const items = document.querySelectorAll('#membersList .member-checkbox-item');

            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = select;
                if (select) {
                    items[index]?.classList.add('checked');
                } else {
                    items[index]?.classList.remove('checked');
                }
            });

            updateMembersCount();
        }

        // NUEVO: Mostrar todos los miembros (restaurar vista completa)
        function showAllMembers() {
            const items = document.querySelectorAll('#membersList .member-checkbox-item');
            items.forEach(item => {
                item.style.display = 'flex';
            });
        }

        // MODIFICADO: Seleccionar Y FILTRAR solo los miembros actuales del grupo
        function toggleOnlyMembers() {
            // Limpiar búsqueda primero
            document.getElementById('memberSearchInput').value = '';

            const checkboxes = document.querySelectorAll('#membersList input[type="checkbox"]');
            const items = document.querySelectorAll('#membersList .member-checkbox-item');
            let visibleCount = 0;

            checkboxes.forEach((checkbox, index) => {
                const contactId = checkbox.value;
                const item = items[index];

                // Comparación robusta: convertir a string
                const isMember = originalMemberIds.some(memberId =>
                    String(memberId) === String(contactId)
                );

                if (isMember) {
                    // ES MIEMBRO: Mostrar y seleccionar
                    checkbox.checked = true;
                    item?.classList.add('checked');
                    if (item) {
                        item.style.display = 'flex';
                        visibleCount++;
                    }
                } else {
                    // NO ES MIEMBRO: Ocultar
                    checkbox.checked = false;
                    item?.classList.remove('checked');
                    if (item) {
                        item.style.display = 'none';
                    }
                }
            });

            updateMembersCount();
            showAppMessage(`✅ Mostrando solo los ${visibleCount} miembros actuales del grupo`, 'info');
        }

        // MODIFICADO: Seleccionar Y FILTRAR solo los NO miembros
        function toggleOnlyNonMembers() {
            // Limpiar búsqueda primero
            document.getElementById('memberSearchInput').value = '';

            const checkboxes = document.querySelectorAll('#membersList input[type="checkbox"]');
            const items = document.querySelectorAll('#membersList .member-checkbox-item');
            let visibleCount = 0;

            checkboxes.forEach((checkbox, index) => {
                const contactId = checkbox.value;
                const item = items[index];

                // Comparación robusta: convertir a string
                const isMember = originalMemberIds.some(memberId =>
                    String(memberId) === String(contactId)
                );

                if (!isMember) {
                    // NO ES MIEMBRO: Mostrar y seleccionar
                    checkbox.checked = true;
                    item?.classList.add('checked');
                    if (item) {
                        item.style.display = 'flex';
                        visibleCount++;
                    }
                } else {
                    // ES MIEMBRO: Ocultar
                    checkbox.checked = false;
                    item?.classList.remove('checked');
                    if (item) {
                        item.style.display = 'none';
                    }
                }
            });

            updateMembersCount();
            showAppMessage(`✅ Mostrando solo ${visibleCount} contactos que NO son miembros (listos para añadir)`, 'info');
        }

        // NUEVO: Filtrar lista de miembros por búsqueda
        function filterMembersList() {
            const searchTerm = document.getElementById('memberSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('#membersList .member-checkbox-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // NUEVO: Limpiar mensajes del modal de grupos
        function clearGroupMessages() {
            const messages = ['groupModalMessage', 'groupEditMessage'];
            messages.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '';
                    element.className = 'status-message';
                    element.style.display = 'none';
                }
            });
        }

        // ============ FIN NUEVAS FUNCIONES ============

async function saveGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            
            if (!groupName) {
                const groupModalMessage = document.getElementById('groupModalMessage');
                groupModalMessage.textContent = 'El nombre del grupo es obligatorio.';
                groupModalMessage.className = 'status-message status-error';
                groupModalMessage.style.display = 'block';
                return;
            }

            try {
                const selectedContactsArray = Array.from(selectedContacts).map(id => 
                    contacts.find(c => c.id === id)
                ).filter(Boolean);

                // 1. Crear el grupo
                const { data: newGroup, error: groupError } = await sb
                    .from('contact_groups')
                    .insert([{
                        name: groupName,
                        description: groupDescription,
                        created_by: currentUser?.id || null
                    }])
                    .select()
                    .single();

                if (groupError) throw groupError;

                // 2. Crear las relaciones en contact_group_members
                const memberInserts = selectedContactsArray.map(contact => ({
                    contact_id: contact.id,
                    group_id: newGroup.id,
                    added_by: currentUser?.id || null
                }));

                const { error: membersError } = await sb
                    .from('contact_group_members')
                    .insert(memberInserts);

                if (membersError) throw membersError;

                // 3. Agregar contactos completos al objeto para uso local
                const completeGroup = {
                    ...newGroup,
                    contacts: selectedContactsArray,
                    contact_ids: selectedContactsArray.map(c => c.id)
                };

                savedGroups.unshift(completeGroup);
                setupGroupsFilter();
                
                showAppMessage(`Grupo "${groupName}" creado exitosamente con ${selectedContacts.size} contactos.`, 'success');
                
                closeGroupModal();
                clearSelection();
                
            } catch (error) {
                console.error('Error creando grupo:', error);
                const groupModalMessage = document.getElementById('groupModalMessage');
                groupModalMessage.textContent = 'Error al crear el grupo: ' + error.message;
                groupModalMessage.className = 'status-message status-error';
                groupModalMessage.style.display = 'block';
            }
        }

        // NUEVO: Guardar cambios de grupo (crear o editar) con gestión de membresía
        async function saveGroupChanges() {
            const groupId = document.getElementById('editingGroupId').value;
            const groupName = document.getElementById('editGroupNameInput').value.trim();
            const groupDesc = document.getElementById('editGroupDescInput').value.trim();

            // Validar nombre
            if (!groupName) {
                const message = document.getElementById('groupEditMessage');
                message.textContent = 'El nombre del grupo es obligatorio';
                message.className = 'status-message status-error';
                message.style.display = 'block';
                return;
            }

            // Obtener miembros seleccionados (TODOS los marcados, incluso si están ocultos)
            // IMPORTANTE: Los IDs son UUIDs (strings), NO integers
            const selectedMemberIds = Array.from(
                document.querySelectorAll('#membersList input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            console.log('💾 IDs seleccionados para guardar (UUIDs):', selectedMemberIds);

            if (selectedMemberIds.length === 0) {
                const message = document.getElementById('groupEditMessage');
                message.textContent = 'Debe seleccionar al menos un miembro para el grupo';
                message.className = 'status-message status-error';
                message.style.display = 'block';
                return;
            }

            // Deshabilitar botón de guardar
            const saveBtn = document.querySelector('#groupModalFooter .btn-primary');
            const originalBtnHtml = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                if (groupId) {
                    // EDITAR GRUPO EXISTENTE
                    await updateExistingGroup(groupId, groupName, groupDesc, selectedMemberIds);
                } else {
                    // CREAR NUEVO GRUPO
                    await createNewGroup(groupName, groupDesc, selectedMemberIds);
                }

                showAppMessage(`Grupo "${groupName}" guardado exitosamente`, 'success');
                await loadGroupsFromSupabase(); // Recargar grupos
                showGroupsListView(); // Volver a la lista

            } catch (error) {
                console.error('Error guardando grupo:', error);
                const message = document.getElementById('groupEditMessage');
                message.textContent = 'Error al guardar el grupo: ' + error.message;
                message.className = 'status-message status-error';
                message.style.display = 'block';
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnHtml;
            }
        }

        // NUEVO: Crear nuevo grupo
        async function createNewGroup(name, description, memberIds) {
            // 1. Crear el grupo
            const { data: newGroup, error: groupError } = await sb
                .from('contact_groups')
                .insert([{
                    name: name,
                    description: description,
                    created_by: currentUser?.id || null
                }])
                .select()
                .single();

            if (groupError) throw groupError;

            // 2. Insertar miembros
            const members = memberIds.map(contactId => ({
                group_id: newGroup.id,
                contact_id: contactId
            }));

            const { error: membersError } = await sb
                .from('contact_group_members')
                .insert(members);

            if (membersError) throw membersError;
        }

        // NUEVO: Actualizar grupo existente
        async function updateExistingGroup(groupId, name, description, newMemberIds) {
            // 1. Actualizar nombre y descripción del grupo
            const { error: updateError } = await sb
                .from('contact_groups')
                .update({
                    name: name,
                    description: description
                })
                .eq('id', groupId);

            if (updateError) throw updateError;

            // 2. Obtener miembros actuales
            const { data: currentMembers, error: membersError } = await sb
                .from('contact_group_members')
                .select('contact_id')
                .eq('group_id', groupId);

            if (membersError) throw membersError;

            const currentMemberIds = currentMembers.map(m => m.contact_id);

            // 3. Calcular diferencias (comparación robusta de UUIDs como strings)
            const toAdd = newMemberIds.filter(id =>
                !currentMemberIds.some(memberId => String(memberId) === String(id))
            );
            const toRemove = currentMemberIds.filter(id =>
                !newMemberIds.some(newId => String(newId) === String(id))
            );

            // 4. Eliminar miembros que ya no están
            if (toRemove.length > 0) {
                const { error: deleteError } = await sb
                    .from('contact_group_members')
                    .delete()
                    .eq('group_id', groupId)
                    .in('contact_id', toRemove);

                if (deleteError) throw deleteError;
            }

            // 5. Añadir nuevos miembros
            if (toAdd.length > 0) {
                const newMembers = toAdd.map(contactId => ({
                    group_id: groupId,
                    contact_id: contactId
                }));

                const { error: insertError } = await sb
                    .from('contact_group_members')
                    .insert(newMembers);

                if (insertError) throw insertError;
            }
        }

        // MODIFICADO: Cerrar modal de grupos
        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('active');

            // Limpiar vistas
            showGroupsListView();

            // Limpiar campos de edición
            document.getElementById('editingGroupId').value = '';
            document.getElementById('editGroupNameInput').value = '';
            document.getElementById('editGroupDescInput').value = '';
            document.getElementById('membersList').innerHTML = '';
            document.getElementById('memberSearchInput').value = '';

            clearGroupMessages();
        }

        function sendEmailToSelection() {
    if (selectedContacts.size === 0) {
        showAppMessage('Seleccione al menos un contacto para enviar correo', 'error');
        return;
    }
    
    const selectedContactsArray = Array.from(selectedContacts).map(id => 
        contacts.find(c => c.id === id)
    ).filter(Boolean);
    
    const emails = selectedContactsArray.map(contact => contact.email).filter(Boolean);
    
    if (emails.length === 0) {
        showAppMessage('Los contactos seleccionados no tienen correos válidos', 'warning');
        return;
    }
    
    // Mostrar siempre el modal para copiar la lista de correos
    showEmailCopyModal(emails);
}

        function sendWhatsAppToSelection() {
            if (selectedContacts.size === 0) {
                showAppMessage('Seleccione al menos un contacto para enviar WhatsApp', 'error');
                return;
            }
            
            const selectedContactsArray = Array.from(selectedContacts).map(id => 
                contacts.find(c => c.id === id)
            ).filter(Boolean);
            
            const phones = selectedContactsArray
                .map(contact => contact.Teléfono)
                .filter(Boolean)
                .map(formatPhoneForWhatsApp)
                .filter(Boolean);
            
            if (phones.length === 0) {
                showAppMessage('Los contactos seleccionados no tienen teléfonos registrados o el formato es incorrecto.', 'warning');
                return;
            }
            
            const message = encodeURIComponent('Mensaje de OCHA Maracaibo:\n\n');
            phones.forEach(phone => {
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            });
        }

        function formatPhoneForWhatsApp(phone) {
            if (!phone) return null;
            let cleaned = phone.replace(/\D/g, '');
            if (!cleaned.startsWith('58') && cleaned.length >= 10) {
                cleaned = '58' + cleaned.substring(cleaned.length - 10); 
            } else if (!cleaned.startsWith('58') && cleaned.length < 10) {
                return null; 
            }
            return cleaned; 
        }

        async function handleContactSubmit(e) {
            e.preventDefault();
            
            const contactId = document.getElementById('contactId').value;
            
            const selectedSectores = [];
            document.querySelectorAll('#sectoresMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
                selectedSectores.push(checkbox.value);
            });
            
            const selectedMunicipios = [];
            document.querySelectorAll('#municipiosMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
                selectedMunicipios.push(checkbox.value);
            });
            
            const selectedEspacios = [];
            document.querySelectorAll('#espaciosMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
                selectedEspacios.push(checkbox.value);
            });
            
            const contactData = {
                organizacion: document.getElementById('organizacion').value.trim(),
                siglas: document.getElementById('siglas').value.trim(),
                punto_focal: document.getElementById('punto_focal').value.trim(),
                cargo: document.getElementById('cargo').value.trim(),
                email: document.getElementById('email').value.trim().toLowerCase(),
                Teléfono: document.getElementById('Teléfono').value.trim(),
                tipo_organizacion: document.getElementById('tipo_organizacion').value.trim(),
                espacio_coordinacion: selectedEspacios.join(', '),
                sectores_concat: selectedSectores.join(', '),
                municipios_concat: selectedMunicipios.join(', '),
                reporta_345w: document.getElementById('reporta_345w').checked ? 'Sí' : 'No',
				socio_implementador: document.getElementById('socio_implementador').checked ? 'Sí' : 'No',
				organizacion_lider: document.getElementById('organizacion_lider').checked ? 'Sí' : 'No',
				participacion_flc: document.getElementById('participacion_flc').checked ? 'Sí' : 'No',
            };
            
            try {
                showAppMessage('Guardando contacto...', 'info', false);
                
                let query;
                if (contactId) {
                    query = sb.from('contacts').update(contactData).eq('id', contactId);
                } else {
                    query = sb.from('contacts').insert([contactData]);
                }
                const { error } = await query;
                if (error) throw error;
                
                showAppMessage(contactId ? 'Contacto actualizado' : 'Contacto creado', 'success');
                closeContactModal();
                await loadContacts();
                
            } catch (error) {
                console.error("Error guardando contacto:", error, contactData);
                showAppMessage(`Error guardando contacto: ${error.message}`, 'error');
            }
        }

        function viewContact(id) {
    const contact = contacts.find(c => c.id.toString() === id);
    if (!contact) {
        console.error("Contacto no encontrado para ver:", id);
        return;
    }

    // Función auxiliar para evaluar valores booleanos
    const evaluateBoolean = (value) => {
        if (value === null || value === undefined || value === '') return 'No';
        if (typeof value === 'boolean') return value ? 'Sí' : 'No';
        if (typeof value === 'string') {
            const lowerValue = value.toLowerCase().trim();
            return (lowerValue === 'sí' || lowerValue === 'si' || lowerValue === 'true' || lowerValue === '1') ? 'Sí' : 'No';
        }
        return value ? 'Sí' : 'No';
    };

    const viewBody = document.getElementById('viewContactBody');
    viewBody.innerHTML = `
        <h4 style="color: var(--color-ochablue); margin-bottom: 1rem;">${contact.organizacion || 'N/A'} (${contact.siglas || 'N/A'})</h4>
        <p><strong>Punto Focal:</strong> ${contact.punto_focal || 'N/A'}</p>
        <p><strong>Cargo:</strong> ${contact.cargo || 'N/A'}</p>
        <p><strong>Email:</strong> ${contact.email || 'N/A'}<i class="fas fa-copy copy-icon" title="Copiar email" onclick="copyToClipboard('${contact.email}', this)"></i></p>
        <p><strong>Teléfono:</strong> ${contact.Teléfono || 'N/A'}</p>
        <p><strong>Tipo de Organización:</strong> ${contact.tipo_organizacion || 'N/A'}</p>
        <p><strong>Espacio de Coordinación:</strong> ${contact.espacio_coordinacion || 'N/A'}</p>
        <hr>
        <h5 style="color: var(--color-ochablue); margin-top: 1rem; margin-bottom: 0.5rem;">Sectores</h5>
        <p>${contact.sectores_concat || 'No especificado'}</p>
        <h5 style="color: var(--color-ochablue); margin-top: 1rem; margin-bottom: 0.5rem;">Municipios</h5>
        <p>${contact.municipios_concat || 'No especificado'}</p>
        <hr>
        <h5 style="color: var(--color-ochablue); margin-top: 1rem; margin-bottom: 0.5rem;">Participación</h5>
        <p><strong>Reporta en el 345W:</strong> ${evaluateBoolean(contact.reporta_345w)}</p>
        <p><strong>Socio Implementador:</strong> ${evaluateBoolean(contact.socio_implementador)}</p>
        <p><strong>Organización Líder:</strong> ${evaluateBoolean(contact.organizacion_lider)}</p>
        <p><strong>Participación FLC:</strong> ${evaluateBoolean(contact.participacion_flc)}</p>
    `;

    document.getElementById('viewContactModal').classList.add('active');
}

        function closeViewContactModal() {
            document.getElementById('viewContactModal').classList.remove('active');
        }

        async function editContact(id) {
            const contact = contacts.find(c => c.id.toString() === id);
            if (!contact) {
                console.error("Contacto no encontrado para editar:", id);
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Editar Contacto';
            document.getElementById('contactId').value = id;
            
            // Llenar campos del formulario
            document.getElementById('organizacion').value = contact.organizacion || '';
            document.getElementById('siglas').value = contact.siglas || '';
            document.getElementById('punto_focal').value = contact.punto_focal || '';
            document.getElementById('cargo').value = contact.cargo || '';
            document.getElementById('email').value = contact.email || '';
            document.getElementById('Teléfono').value = contact.Teléfono || '';
            document.getElementById('tipo_organizacion').value = contact.tipo_organizacion || '';
            
			// Establecer checkboxes
			document.getElementById('reporta_345w').checked = (contact.reporta_345w === 'Sí' || contact.reporta_345w === true);
			document.getElementById('socio_implementador').checked = (contact.socio_implementador === 'Sí' || contact.socio_implementador === true);
			document.getElementById('organizacion_lider').checked = (contact.organizacion_lider === 'Sí' || contact.organizacion_lider === true);
			document.getElementById('participacion_flc').checked = (contact.participacion_flc === 'Sí' || contact.participacion_flc === true);
            
            // Establecer checkboxes de multi-selección para Sectores
            const contactSectores = (contact.sectores_concat || '').split(',').map(s => s.trim());
            document.querySelectorAll('#sectoresMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = contactSectores.includes(checkbox.value);
            });
            
            // Establecer checkboxes de multi-selección para Municipios
            const contactMunicipios = (contact.municipios_concat || '').split(',').map(m => m.trim());
            document.querySelectorAll('#municipiosMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = contactMunicipios.includes(checkbox.value);
            });
            
            // Establecer checkboxes de multi-selección para Espacios
            const contactEspacios = (contact.espacio_coordinacion || '').split(',').map(e => e.trim());
            document.querySelectorAll('#espaciosMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = contactEspacios.includes(checkbox.value);
            });
            
            document.getElementById('contactModal').classList.add('active');
        }

        // MODIFICADO: Eliminación sin contraseña - Solo confirmación simple
        async function deleteContact(id) {
            pendingDeleteId = id;
            const contact = contacts.find(c => c.id === id);

            if (!contact) {
                showAppMessage('Contacto no encontrado', 'error');
                return;
            }

            // Mostrar información del contacto en el modal
            const deleteContactInfo = document.getElementById('deleteContactInfo');
            deleteContactInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-user-circle" style="font-size: 2.5rem; color: var(--color-ochablue);"></i>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 700; font-size: 1.1rem; color: var(--color-ochablue);">
                            ${contact.punto_focal || 'Sin nombre'}
                        </p>
                        <p style="margin: 0.25rem 0 0 0; color: var(--color-ochagrey); font-size: 0.95rem;">
                            <i class="fas fa-building" style="margin-right: 0.5rem;"></i>
                            ${contact.organizacion || 'Sin organización'}
                        </p>
                        <p style="margin: 0.25rem 0 0 0; color: var(--color-ochagrey); font-size: 0.9rem;">
                            <i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>
                            ${contact.email || 'Sin email'}
                        </p>
                    </div>
                </div>
            `;

            // Mostrar el modal de confirmación
            document.getElementById('deleteContactModal').classList.add('active');
        }

        // MODIFICADO: Solo para crear grupos (la eliminación de contactos ya no requiere contraseña)
        function confirmAdminAction() {
            const passwordInput = document.getElementById('adminPassword');
            const adminPasswordError = document.getElementById('adminPasswordError');
            const enteredPassword = passwordInput.value;

            if (enteredPassword === ADMIN_PASSWORD) {
                adminPasswordError.textContent = '';
                adminPasswordError.style.display = 'none';
                passwordInput.value = '';
                document.getElementById('adminPasswordModal').classList.remove('active');

                // Ejecutar la acción pendiente (solo crear grupo con contactos pre-seleccionados)
                if (pendingAdminAction === 'createGroup') {
                    showGroupModal(selectedContacts); // Pasar contactos seleccionados
                }

                pendingAdminAction = null;
            } else {
                adminPasswordError.textContent = 'Clave de administrador incorrecta.';
                adminPasswordError.style.display = 'block';
            }
        }

        // MODIFICADO: Ya no maneja pendingDeleteId (solo para crear grupos)
        function closeAdminPasswordModal() {
            document.getElementById('adminPasswordModal').classList.remove('active');
            document.getElementById('adminPassword').value = '';
            const adminPasswordError = document.getElementById('adminPasswordError');
            adminPasswordError.textContent = '';
            adminPasswordError.style.display = 'none';
            pendingAdminAction = null;
        }

        async function performDelete(id) {
            try {
                showAppMessage('Eliminando contacto...', 'info', false);
                const { error } = await sb.from('contacts').delete().eq('id', id);
                if (error) throw error;
                showAppMessage('Contacto eliminado exitosamente', 'success');
                await loadContacts();
            } catch (error) {
                showAppMessage('Error eliminando contacto: ' + error.message, 'error');
            }
        }

        // NUEVO: Función para confirmar eliminación desde el modal simple
        async function confirmDeleteContact() {
            if (!pendingDeleteId) {
                closeDeleteContactModal();
                return;
            }

            const deleteBtn = document.querySelector('#deleteContactModal .btn-danger');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';

            try {
                await performDelete(pendingDeleteId);
                closeDeleteContactModal();
                pendingDeleteId = null;
            } catch (error) {
                const message = document.getElementById('deleteContactModalMessage');
                message.textContent = 'Error al eliminar el contacto: ' + error.message;
                message.className = 'status-message status-error';
                message.style.display = 'block';
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Sí, Eliminar';
            }
        }

        // NUEVO: Función para cerrar el modal de confirmación de eliminación
        function closeDeleteContactModal() {
            document.getElementById('deleteContactModal').classList.remove('active');
            document.getElementById('deleteContactInfo').innerHTML = '';
            const message = document.getElementById('deleteContactModalMessage');
            message.textContent = '';
            message.style.display = 'none';
            pendingDeleteId = null;

            // Restaurar el botón
            const deleteBtn = document.querySelector('#deleteContactModal .btn-danger');
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Sí, Eliminar';
            }
        }

        function showAddContactModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Contacto';
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            document.getElementById('tipo_organizacion').selectedIndex = 0;
            
            // Limpiar todos los checkboxes de multi-selección
            document.querySelectorAll('#sectoresMultiSelect input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('#municipiosMultiSelect input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('#espaciosMultiSelect input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
			
			    // AGREGA ESTAS LÍNEAS PARA LIMPIAR LOS CHECKBOXES DE PARTICIPACIÓN:
			document.getElementById('reporta_345w').checked = false;
			document.getElementById('socio_implementador').checked = false;
			document.getElementById('organizacion_lider').checked = false;
			document.getElementById('participacion_flc').checked = false;
            
            document.getElementById('contactModal').classList.add('active');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showAppMessage(message, type, autoHide = true) {
            const messageEl = document.getElementById('appStatusMessage');
            messageEl.textContent = message;
            messageEl.className = `status-message status-${type}`;
            messageEl.style.display = 'block';
            
            if (autoHide) {
                setTimeout(() => {
                    if (messageEl.textContent === message) { 
                        messageEl.style.display = 'none';
                    }
                }, 5000);
            }
        }

        function hideAuthMessages() {
            ['loginError', 'loginSuccess', 'registerError', 'registerSuccess', 'resetError', 'resetSuccess'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = '';
                    el.style.display = 'none';
                }
            });
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (!errorEl) return;
            
            const successId = elementId.replace("Error", "Success");
            const successEl = document.getElementById(successId);
            if (successEl) {
                successEl.textContent = '';
                successEl.style.display = 'none';
            }
            
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(elementId, message) {
            const successEl = document.getElementById(elementId);
            if (!successEl) return;
            
            const errorId = elementId.replace("Success", "Error");
            const errorEl = document.getElementById(errorId);
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }
            
            successEl.textContent = message;
            successEl.style.display = 'block';
            
            setTimeout(() => {
                if (successEl.textContent === message) {
                    successEl.textContent = '';
                    successEl.style.display = 'none';
                }
            }, 5000);
        }

window.addEventListener('DOMContentLoaded', async () => {
    // PRIMERO: Verificar registro público ANTES de hacer CUALQUIER otra cosa
    const urlParams = new URLSearchParams(window.location.search);
    
    console.log('🔍 URL completa:', window.location.href);
    console.log('🔍 Parámetros URL:', Object.fromEntries(urlParams));
    
    if (urlParams.has('public_register')) {
        console.log('✅ Registro público detectado');
        showPublicRegistration();
        return; // SALIR COMPLETAMENTE - no hacer nada más
    }
    
    // Modo sin autenticación: pedir clave antes de cargar
    if (DISABLE_AUTH) {
        promptViewerAccess();
        return;
    }
    
    // Solo si NO es registro público, continuar con autenticación
    console.log('❌ No es registro público - Continuando con autenticación');
    setupAuthEventListeners();
    
    // Verificar sesión persistente primero
    try {
        const { data: { session }, error } = await sb.auth.getSession();
        if (error) {
            console.error('Error obteniendo sesión:', error);
        }
        
        if (session && session.user) {
            console.log('✅ Sesión persistente encontrada:', session.user.email);
            currentUser = session.user;
            showMainApp();
        } else {
            console.log('❌ No hay sesión persistente');
            if (DISABLE_AUTH) {
                showMainApp();
            } else {
                showLoginPage();
            }
        }
    } catch (error) {
        console.error('Error verificando sesión:', error);
        if (DISABLE_AUTH) {
            showMainApp();
        } else {
            showLoginPage();
        }
    }
});
        sb.auth.onAuthStateChange(async (event, session) => {
            if (DISABLE_AUTH) return;
            console.log('Evento de autenticación:', event, session);
            const previousUser = currentUser;
            
            if (event === "PASSWORD_RECOVERY") {
                console.log("Recuperación de contraseña iniciada.");
                showSuccess('loginSuccess', 'Se ha iniciado el proceso de recuperación de contraseña.');
            }
            
            if (session && session.user) {
                currentUser = session.user;
                if (document.getElementById('mainApp').style.display === 'none' || (previousUser && previousUser.id !== currentUser.id)) {
                    appInitialized = false;
                    showMainApp();
                } else if (document.getElementById('mainApp').style.display === 'block' && !appInitialized) {
                    await initializeApp();
                }
                document.getElementById('userEmail').textContent = currentUser.email;
            } else {
                currentUser = null;
                if (appInitialized) {
                    if (contactChangesChannel) {
                        try {
                            await sb.removeChannel(contactChangesChannel);
                        } catch(e) {
                            console.warn("Error eliminando canal anterior:", e);
                        }
                    }
                }
                appInitialized = false;
                showLoginPage();
            }
        });

        function showAuthForm(formToShow) {
            hideAuthMessages();
            document.getElementById('loginForm').style.display = formToShow === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = formToShow === 'register' ? 'block' : 'none';
            document.getElementById('passwordResetForm').style.display = formToShow === 'reset' ? 'block' : 'none';

            document.getElementById('linkToRegister').style.display = formToShow === 'login' ? 'block' : 'none';
            document.getElementById('linkToPasswordReset').style.display = formToShow === 'login' ? 'block' : 'none';
            
            document.getElementById('linkToLoginFromRegister').style.display = formToShow === 'register' ? 'block' : 'none';
            document.getElementById('linkToLoginFromReset').style.display = formToShow === 'reset' ? 'block' : 'none';
        }
function rememberUser(email) {
    try {
        localStorage.setItem('ocha-last-user', email);
    } catch (error) {
        console.warn('No se pudo guardar usuario en localStorage:', error);
    }
}

function getRememberedUser() {
    try {
        return localStorage.getItem('ocha-last-user') || '';
    } catch (error) {
        console.warn('No se pudo leer usuario de localStorage:', error);
        return '';
    }
}

function populateLoginForm() {
    const rememberedEmail = getRememberedUser();
    if (rememberedEmail) {
        document.getElementById('loginEmail').value = rememberedEmail;
    }
}
        async function handleLogin(e) {
            e.preventDefault();
            hideAuthMessages();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // En modo sin auth, validamos contra lista local
            if (DISABLE_AUTH) {
                const passNormalized = (password || '').trim().toLowerCase();
                if (ALLOWED_VIEWER_PASSWORDS.includes(passNormalized)) {
                    viewerAccessAllowed = true;
                    currentUser = { email: 'ochaviewer@ocha' };
                    showSuccess('loginSuccess', 'Acceso otorgado.');
                    showMainApp();
                } else {
                    showError('loginError', 'Clave incorrecta. Usa: Laura, Jhozman, Enrique u Oficial Falc?n.');
                }
                return;
            }

            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) throw error;
                rememberUser(email); // Guardar email para proxima vez
                showSuccess('loginSuccess', 'Ingreso exitoso. Redirigiendo...');
                // Si la sesion viene en la respuesta, avanzar sin esperar el listener
                if (data && (data.session?.user || data.user)) {
                    currentUser = data.session?.user || data.user;
                    showMainApp();
                }
            } catch (error) {
                let errorMessage = error.message;
                if (errorMessage.includes('Failed to fetch')) {
                    errorMessage = 'Error de red o CORS. Verifique su conexion a internet.';
                } else if (errorMessage.includes('Invalid login credentials')) {
                    errorMessage = 'Credenciales invalidas. Por favor, revise su correo y contraseña.';
                } else if (errorMessage.includes('Email not confirmed')) {
                    errorMessage = 'Su correo electronico no ha sido confirmado. Revise su bandeja de entrada para el enlace de confirmacion.';
                }
                showError('loginError', `Error al ingresar: ${errorMessage}`);
            }
        }
async function handleRegister(e) {
            e.preventDefault();
            hideAuthMessages();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const { data, error } = await sb.auth.signUp({ email, password });
                if (error) throw error;
                
                if (data.user && data.user.identities && data.user.identities.length === 0) {
                    showError('registerError', 'Este correo ya está registrado y requiere confirmación.');
                } else if (data.user && (data.user.email_confirmed_at === null && data.session === null)) {
                    showSuccess('registerSuccess', '¡Registro exitoso! Revisa tu correo para confirmar tu cuenta.');
                } else {
                    showSuccess('registerSuccess', '¡Registro exitoso! Ahora puedes ingresar.');
                    showAuthForm('login');
                }
            } catch (error) {
                let errorMessage = error.message;
                if (errorMessage.includes("duplicate key value violates unique constraint")) {
                    errorMessage = "Este correo electrónico ya está en uso.";
                }
                showError('registerError', `Error en el registro: ${errorMessage}`);
            }
        }

        async function handlePasswordResetRequest(e) {
            e.preventDefault();
            hideAuthMessages();
            const email = document.getElementById('resetEmail').value;
            
            try {
                const { error } = await sb.auth.resetPasswordForEmail(email, {
                    redirectTo: new URL('update-password.html', window.location.href).href
                });
                if (error) throw error;
                showSuccess('resetSuccess', 'Si existe una cuenta asociada a este correo, se ha enviado un enlace para restablecer la contraseña.');
            } catch (error) {
                let errorMessage = error.message;
                 if (errorMessage.includes("User not found")) {
                    errorMessage = "No se encontró ningún usuario con este correo electrónico.";
                }
                showError('resetError', 'Error al solicitar reseteo: ' + errorMessage);
            }
        }

// Solicitar clave de acceso en modo sin autenticacion (modal)
function openAccessModal() {
    document.documentElement.classList.add('access-locked');
    const msg = document.getElementById('accessModalMessage');
    msg.textContent = '';
    msg.className = 'status-message';
    msg.style.display = 'none';
    const input = document.getElementById('accessPassword');
    input.value = '';
    document.getElementById('accessModal').classList.add('active');
    setTimeout(() => input.focus(), 50);
}

function closeAccessModal() {
    document.getElementById('accessModal').classList.remove('active');
}

function submitAccessPassword() {
    const passNormalized = (document.getElementById('accessPassword').value || '').trim().toLowerCase();
    const msg = document.getElementById('accessModalMessage');
    if (ALLOWED_VIEWER_PASSWORDS.includes(passNormalized)) {
        viewerAccessAllowed = true;
        currentUser = { email: 'ochaviewer@ocha' };
        document.documentElement.classList.remove('access-locked');
        closeAccessModal();
        showMainApp();
    } else {
        viewerAccessAllowed = false;
        msg.textContent = 'Contraseña incorrecta.';
        msg.className = 'status-message status-error';
        msg.style.display = 'block';
    }
}

function promptViewerAccess() {
    if (!DISABLE_AUTH) return;
    // Ocultar vistas mientras se pide clave
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    openAccessModal();
}

async function handleLogout() {
    showAppMessage("Cerrando sesión...", "info", false);
    try {
        if (!DISABLE_AUTH) {
            await sb.auth.signOut();
        }
        viewerAccessAllowed = false;
        currentUser = null;
        contacts = [];
        filteredContacts = [];
        appInitialized = false;
        applyFilters();
        showAuthForm('login');
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        showAppMessage("Ingresa la clave de acceso para reingresar.", "info");
        if (DISABLE_AUTH) {
            promptViewerAccess();
        }
    } catch (error) {
        console.error("Error durante el logout:", error);
        showAppMessage("Error al cerrar sesión. Inténtalo de nuevo.", "error");
    }
}

        function showMainApp() {
            console.log('Mostrando aplicación principal para usuario:', currentUser?.email);
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            if (currentUser) {
                document.getElementById('userEmail').textContent = currentUser.email;
            }
            if (!appInitialized) {
                initializeApp();
            }
        }

function showLoginPage() {
    if (DISABLE_AUTH && !viewerAccessAllowed) {
        // permitir mostrar login para volver a pedir clave de acceso
    } else if (DISABLE_AUTH) {
        return;
    }
    console.log('Mostrando página de login');
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    showAuthForm('login');
    // Rellenar email recordado
    setTimeout(() => {
        populateLoginForm();
    }, 100);
}
async function loadGroups() {
            try {
                console.log('🔄 Cargando grupos desde Supabase...');
                // 1. Cargar grupos
                const { data: groups, error: groupsError } = await sb
                    .from('contact_groups')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (groupsError) throw groupsError;

                console.log(`📦 Grupos cargados:`, groups);

                // 2. Para cada grupo, cargar sus contactos
                savedGroups = await Promise.all((groups || []).map(async (group) => {
                    console.log(`  👥 Cargando miembros del grupo "${group.name}" (ID: ${group.id}, tipo: ${typeof group.id})`);

                    // Obtener IDs de contactos del grupo
                    const { data: members, error: membersError } = await sb
                        .from('contact_group_members')
                        .select('contact_id')
                        .eq('group_id', group.id);

                    if (membersError) {
                        console.error('❌ Error cargando miembros del grupo:', membersError);
                        return { ...group, contacts: [], contact_ids: [] };
                    }

                    const contactIds = members.map(m => m.contact_id);
                    // Comparación robusta: ambos son UUIDs (strings)
                    const groupContacts = contacts.filter(c =>
                        contactIds.some(memberId => String(memberId) === String(c.id))
                    );

                    console.log(`  ✅ Grupo "${group.name}": ${contactIds.length} miembros`);

                    return {
                        ...group,
                        contacts: groupContacts,
                        contact_ids: contactIds
                    };
                }));

                setupGroupsFilter();
                console.log(`✅ ${savedGroups.length} grupos cargados exitosamente`);
            } catch (error) {
                console.error('❌ Error cargando grupos:', error);
                showAppMessage('Error cargando grupos: ' + error.message, 'error');
                savedGroups = [];
            }
        }

        // Alias para compatibilidad
        const loadGroupsFromSupabase = loadGroups;

        // FUNCIÓN DE DIAGNÓSTICO - Ejecuta desde la consola: await diagnosticarGrupos()
        async function diagnosticarGrupos() {
            console.log('🔍 === DIAGNÓSTICO DE GRUPOS ===');

            try {
                // 1. Verificar grupos en Supabase
                console.log('\n1️⃣ Consultando contact_groups en Supabase...');
                const { data: grupos, error: errorGrupos } = await sb
                    .from('contact_groups')
                    .select('*');

                if (errorGrupos) {
                    console.error('❌ Error consultando grupos:', errorGrupos);
                } else {
                    console.log(`✅ Grupos en Supabase: ${grupos?.length || 0}`);
                    grupos?.forEach(g => {
                        console.log(`   📁 "${g.name}" (ID: ${g.id}, tipo: ${typeof g.id})`);
                    });
                }

                // 2. Verificar miembros en Supabase
                console.log('\n2️⃣ Consultando contact_group_members en Supabase...');
                const { data: miembros, error: errorMiembros } = await sb
                    .from('contact_group_members')
                    .select('*');

                if (errorMiembros) {
                    console.error('❌ Error consultando miembros:', errorMiembros);
                } else {
                    console.log(`✅ Registros de membresía: ${miembros?.length || 0}`);
                    console.log(`   Tipos de datos: group_id=${typeof miembros?.[0]?.group_id}, contact_id=${typeof miembros?.[0]?.contact_id}`);
                }

                // 3. Estado actual en memoria
                console.log('\n3️⃣ Estado en memoria (savedGroups):');
                console.log(`   Array length: ${savedGroups.length}`);
                savedGroups.forEach(g => {
                    console.log(`   📁 "${g.name}" con ${g.contacts?.length || 0} contactos`);
                });

                // 4. Verificar tipos de IDs de contactos
                console.log('\n4️⃣ Tipos de IDs en contacts array:');
                if (contacts.length > 0) {
                    console.log(`   Total contactos cargados: ${contacts.length}`);
                    console.log(`   Primer contacto ID: ${contacts[0].id} (tipo: ${typeof contacts[0].id})`);
                } else {
                    console.log('   ⚠️ Array de contactos vacío');
                }

                console.log('\n✅ Diagnóstico completado');
                return { grupos, miembros, savedGroups, contacts };

            } catch (error) {
                console.error('❌ Error en diagnóstico:', error);
                return { error };
            }
        }

        async function loadContacts() {
            try {
                showAppMessage('Cargando contactos...', 'info', false);
                const { data, error } = await sb
                    .from('contacts')
                    .select('*')
                    .order('organizacion', { ascending: true });
                    
                if (error) throw error;
                
                contacts = data || [];
                setupDynamicFilters();
                applyFilters();
                showAppMessage(`Cargados ${contacts.length} contactos.`, 'success');
            } catch (error) {
                console.error('Error cargando contactos:', error);
                showAppMessage('Error cargando contactos: ' + error.message, 'error');
            }
        }

        function handleSearch() {
            activeFilters.search = document.getElementById('searchInput').value.toLowerCase();
            applyFilters();
        }

        function handleEspacioFilter() {
            activeFilters.espacio = document.getElementById('espacioFilter').value;
            applyFilters();
        }

        function applyFilters() {
            filteredContacts = contacts.filter(contact => {
                // Filtro de búsqueda general (barra principal)
                if (activeFilters.search) {
                    const searchStr = activeFilters.search;
                    const searchFields = [
                        contact.organizacion,
                        contact.siglas,
                        contact.punto_focal,
                        contact.cargo,
                        contact.email,
                        contact.Teléfono,
                        contact.tipo_organizacion,
                        contact.espacio_coordinacion,
                        contact.sectores_concat,
                        contact.municipios_concat
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!searchFields.includes(searchStr)) return false;
                }

                // Filtro de búsqueda general (sidebar)
                if (activeFilters.generalSearch) {
                    const generalSearchStr = activeFilters.generalSearch;
                    const searchFields = [
                        contact.organizacion,
                        contact.siglas,
                        contact.punto_focal,
                        contact.cargo,
                        contact.email,
                        contact.Teléfono,
                        contact.tipo_organizacion,
                        contact.espacio_coordinacion,
                        contact.sectores_concat,
                        contact.municipios_concat
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!searchFields.includes(generalSearchStr)) return false;
                }

                // Filtro por tipo de organización
                if (activeFilters.tipoOrganizacion && contact.tipo_organizacion !== activeFilters.tipoOrganizacion) return false;

                // Filtro por organización (basado en siglas)
                if (activeFilters.organizacion) {
                    const contactOrg = contact.siglas || contact.organizacion || '';
                    if (contactOrg !== activeFilters.organizacion) return false;
                }
                
                // FILTRO MULTIESPACIO: Un contacto puede aparecer en varios espacios sin duplicación
                // Si un contacto pertenece a ["Protección", "Salud"], aparecerá en ambos filtros
                // pero sigue siendo UN SOLO registro en la base de datos
if (activeFilters.espacio) {
    const contactEspacios = getEspaciosAsArray(contact.espacio_coordinacion);
    const hasMatchingEspacio = contactEspacios.includes(activeFilters.espacio);
    if (!hasMatchingEspacio) return false;
}
// Filtro de sectores - CORREGIDO PARA DATOS REALES
if (activeFilters.sectores.length > 0) {
    const contactSectoresString = (contact.sectores_concat || '').toLowerCase();
    const hasMatchingSector = activeFilters.sectores.some(sector => {
        const sectorLower = sector.toLowerCase();
        
        // Manejar casos específicos según los datos reales
        if (sectorLower.includes('agua')) {
            return contactSectoresString.includes('agua saneamiento e higiene') || 
                   contactSectoresString.includes('agua');
        }
        if (sectorLower.includes('alojamiento')) {
            return contactSectoresString.includes('alojamiento energia y enseres') || 
                   contactSectoresString.includes('alojamiento');
        }
        if (sectorLower.includes('coordinación')) {
            return contactSectoresString.includes('coordinacion');
        }
        if (sectorLower.includes('educación')) {
            return contactSectoresString.includes('educacion');
        }
        if (sectorLower.includes('nutrición')) {
            return contactSectoresString.includes('nutricion');
        }
        if (sectorLower.includes('protección general')) {
            return contactSectoresString.includes('proteccion general');
        }
        if (sectorLower.includes('protección niños')) {
            return contactSectoresString.includes('proteccion ninos ninas adolescentes');
        }
        if (sectorLower.includes('violencia de género')) {
            return contactSectoresString.includes('proteccion violencia de genero');
        }
        if (sectorLower.includes('salud')) {
            return contactSectoresString.includes('salud');
        }
        if (sectorLower.includes('seguridad alimentaria')) {
            return contactSectoresString.includes('seguridad alimentaria');
        }
        
        // Búsqueda genérica como respaldo
        return contactSectoresString.includes(sectorLower);
    });
    if (!hasMatchingSector) return false;
}
                
// Filtro de municipios
if (activeFilters.municipios.length > 0) {
    const contactMunicipios = (contact.municipios_concat || '').split(',').map(m => m.trim().toLowerCase());
    const hasMatchingMunicipio = activeFilters.municipios.some(municipio => 
        contactMunicipios.includes(municipio.toLowerCase())
    );
    if (!hasMatchingMunicipio) return false;
}

// FILTRO DE GRUPOS PERSONALIZADOS: Relación Many-to-Many
                // Los grupos usan tabla intermedia 'contact_group_members'
                // Permite que un contacto esté en múltiples grupos sin duplicar su información
                if (activeFilters.selectedGroup !== null) {
    const selectedGroup = savedGroups.find(g => g.id === activeFilters.selectedGroup);
    if (selectedGroup && selectedGroup.contact_ids) {
        // Comparación robusta de UUIDs
        const isInGroup = selectedGroup.contact_ids.some(groupContactId =>
            String(groupContactId) === String(contact.id)
        );
        if (!isInGroup) return false;
    } else {
        return false;
    }
}
                return true;
            });
            
            // Aplicar ordenamiento
            filteredContacts.sort((a, b) => {
                let valA = a[sortField];
                let valB = b[sortField];

                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderContacts();
            updateKPIs();
            clearSelection();
        }

        function resetFilters() {
activeFilters = { 
                search: '', 
                generalSearch: '',
                tipoOrganizacion: '',
                organizacion: '',
                espacio: '', 
                sectores: [], 
                municipios: [],
                selectedGroup: null
            };
            document.getElementById('searchInput').value = '';
            document.getElementById('generalSearchFilter').value = '';
            document.getElementById('tipoOrganizacionFilter').value = '';
            document.getElementById('organizacionFilter').value = '';
            document.getElementById('espacioFilter').value = '';
            document.getElementById('municipiosFilter').value = '';
            document.querySelectorAll('.icon-item.active').forEach(item => item.classList.remove('active'));
			document.querySelectorAll('.group-filter-item.active').forEach(item => item.classList.remove('active'));
            applyFilters();
        }

        function updateKPIs() {
            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = '';
            
 const orgs = new Set(filteredContacts.map(c => c.organizacion).filter(Boolean));
const uniqueEspacios = new Set(filteredContacts.map(c => c.espacio_coordinacion).filter(Boolean));

// Contar sectores usando la misma lógica del filtro
const sectoresEnUso = new Set();
sectoresList.forEach(sectorPredefinido => {
    const sectorEncontrado = filteredContacts.some(contact => {
        if (!contact.sectores_concat) return false;
        
        const contactSectoresString = contact.sectores_concat.toLowerCase();
        const sectorLower = sectorPredefinido.toLowerCase();
        
        // Usar la misma lógica exacta que el filtro
        if (sectorLower.includes('agua')) {
            return contactSectoresString.includes('agua saneamiento e higiene') || 
                   contactSectoresString.includes('agua');
        }
        if (sectorLower.includes('alojamiento')) {
            return contactSectoresString.includes('alojamiento energia y enseres') || 
                   contactSectoresString.includes('alojamiento');
        }
        if (sectorLower.includes('coordinación')) {
            return contactSectoresString.includes('coordinacion');
        }
        if (sectorLower.includes('educación')) {
            return contactSectoresString.includes('educacion');
        }
        if (sectorLower.includes('nutrición')) {
            return contactSectoresString.includes('nutricion');
        }
        if (sectorLower.includes('protección general')) {
            return contactSectoresString.includes('proteccion general');
        }
        if (sectorLower.includes('protección niños')) {
            return contactSectoresString.includes('proteccion ninos ninas adolescentes');
        }
        if (sectorLower.includes('violencia de género')) {
            return contactSectoresString.includes('proteccion violencia de genero');
        }
        if (sectorLower.includes('salud')) {
            return contactSectoresString.includes('salud');
        }
        if (sectorLower.includes('seguridad alimentaria')) {
            return contactSectoresString.includes('seguridad alimentaria');
        }
        
        // Búsqueda genérica como respaldo
        return contactSectoresString.includes(sectorLower);
    });
    
    if (sectorEncontrado) {
        sectoresEnUso.add(sectorPredefinido);
    }
});
createKPICard(kpiGrid, { icon: 'fa-users', value: filteredContacts.length, label: 'Total Contactos' });
createKPICard(kpiGrid, { icon: 'fa-building', value: orgs.size, label: 'Organizaciones' });
createKPICard(kpiGrid, { icon: 'fa-map-marker-alt', value: uniqueEspacios.size, label: 'Espacios Coord.' });
createKPICard(kpiGrid, { icon: 'fa-th-list', value: sectoresEnUso.size, label: 'Sectores Activos' });
        }

        function createKPICard(container, data) {
            const div = document.createElement('div');
            div.className = 'kpi-card';
            div.innerHTML = `
                <i class="fas ${data.icon} kpi-icon"></i>
                <div class="kpi-value">${data.value}</div>
                <div class="kpi-label">${data.label}</div>
            `;
            container.appendChild(div);
        }

        function copyToClipboard(text, element) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                const originalIconClass = element.className;
                const originalColor = element.style.color;
                element.className = 'fas fa-check-circle';
                element.style.color = 'var(--ocha-green)';
                
                setTimeout(() => {
                    element.className = originalIconClass;
                    element.style.color = originalColor;
                }, 1500);
            }).catch(err => {
                console.error('Error copying to clipboard: ', err);
                showAppMessage('Error al copiar el correo', 'error');
            });
        }

        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            // Actualizar iconos de ordenamiento
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
            });
            
            const currentHeader = document.querySelector(`th[onclick="sortTable('${field}')"] .sort-icon`);
            if (currentHeader) {
                currentHeader.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon`;
            }
            
            applyFilters();
        }

        async function generateMagicLink() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showError('loginError', 'Por favor, ingrese su correo electrónico para generar el enlace.');
                return;
            }

            try {
                const { data: contact, error: contactError } = await sb
                    .from('contacts')
                    .select('id')
                    .eq('email', email)
                    .single();
                
                let contactId = contact ? contact.id : null;

                const magicLink = await generateRealMagicLink(email, contactId);
                
                showSuccess('loginSuccess', 'Se ha generado un enlace de actualización. Si el email está asociado a un contacto, revisa tu bandeja para el enlace.');
                
            } catch (error) {
                console.error('Error generando magic link para email:', error);
                showError('loginError', 'Error generando enlace: ' + error.message);
            }
        }

        async function showQRModal(contactId) {
            const contact = contacts.find(c => c.id.toString() === contactId);
            if (!contact) {
                showAppMessage('Contacto no encontrado', 'error');
                return;
            }

            const waitForQRCode = (callback) => {
                if (typeof QRCode !== 'undefined') {
                    callback();
                } else {
                    let attempts = 0;
                    const interval = setInterval(() => {
                        attempts++;
                        if (typeof QRCode !== 'undefined') {
                            clearInterval(interval);
                            callback();
                        } else if (attempts > 20) {
                            clearInterval(interval);
                            console.error('La librería QRCode falló al cargar a tiempo.');
                            showAppMessage('Error: La librería para generar códigos QR no se ha cargado. Revise su conexión a internet y recargue la página.', 'error');
                        }
                    }, 250);
                }
            };

            waitForQRCode(async () => {
                try {
                    currentQRContactId = contactId;
                    document.getElementById('qrContactName').textContent = `${contact.organizacion} - ${contact.punto_focal}`;
                    
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--color-ochablue);"></i><br><p style="margin-top: 1rem;">Generando enlace seguro...</p></div>';
                    
                    document.getElementById('qrModal').classList.add('active');
                    
                    const updateUrl = await generateRealMagicLink(contact.email, contactId);
                    
                    console.log('📏 Longitud final de URL para QR:', updateUrl.length);
                    
                    if (updateUrl.length > 800) {
                        console.warn('URL demasiado larga para QR, usando versión acortada');
                        const shortUrl = `https://ochavenezuela.github.io/update-contact.html?id=${contactId}`;
                        console.log('📏 URL acortada:', shortUrl.length, 'caracteres');
                        generateQRCode(qrContainer, shortUrl);
                    } else {
                        generateQRCode(qrContainer, updateUrl);
                    }
                    
                } catch (error) {
                    console.error('Error generando código QR:', error);
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #cd3a1f;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Error al generar el código QR.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Por favor, intente de nuevo o recargue la página.</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;">Error: ${error.message}</p>
                        </div>`;
                }
            });
        }

        function generateQRCode(container, url) {
            try {
                container.innerHTML= '';
                const qrDiv = document.createElement('div');
                qrDiv.id = 'qrcode-canvas';
                qrDiv.style.display = 'flex';
                qrDiv.style.justifyContent = 'center';
                qrDiv.style.alignItems = 'center';
                container.appendChild(qrDiv);
                
                const qr = new QRCode(qrDiv, {
                    text: url,
                    width: 256,
                    height: 256,
                    colorDark: '#0072BC',
                    colorLight: '#FFFFFF',
                    correctLevel: QRCode.CorrectLevel.L
                });
                
                console.log('✅ Código QR generado exitosamente con magic link:', url);
                
            } catch (error) {
                console.error('Error en generateQRCode:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #cd3a1f;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Error al generar el código QR.</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;">URL demasiado larga: ${error.message}</p>
                    </div>`;
            }
        }

        function downloadQR() {
            try {
                const qrCanvas = document.querySelector('#qrcode-canvas canvas');
                if (qrCanvas) {
                    const link = document.createElement('a');
                    link.download = `qr-contact-${currentQRContactId}.png`;
                    link.href = qrCanvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showAppMessage('Código QR descargado exitosamente', 'success');
                } else {
                    showAppMessage('No se encontró el código QR para descargar.', 'error');
                }
            } catch (error) {
                console.error('Error descargando QR:', error);
                showAppMessage('Error al descargar el código QR: ' + error.message, 'error');
            }
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.remove('active');
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            currentQRContactId = null;
        }
		function showEmailCopyModal(emails) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-envelope"></i> Lista de Correos para Copiar
                </h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-notice">
                    <i class="fas fa-info-circle"></i>
                    <strong>Lista de correos:</strong> ${emails.length} correos electrónicos seleccionados.
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0 1rem;">
                    <p><strong>Total de correos:</strong> ${emails.length}</p>
                    <button class="btn btn-primary" onclick="copyEmailsFromModal()">
                        <i class="fas fa-copy"></i> Copiar Todos
                    </button>
                </div>
                
                <p style="font-size: 0.9rem; color: var(--color-ochagrey); margin-bottom: 0.5rem;">
                    Copie la siguiente lista y péguela en el campo "Para:" o "CCO:" de su cliente de correo:
                </p>
                <textarea id="emailListForCopy" class="form-control" rows="10" readonly 
                          style="font-family: monospace; font-size: 0.85rem; resize: vertical;">${emails.join('; ')}</textarea>
                
                <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="openEmailClientEmpty()">
                        <i class="fas fa-envelope"></i> Abrir Cliente de Correo
                    </button>
                    <button class="btn btn-info" onclick="downloadEmailList([${emails.map(e => `'${e}'`).join(',')}])">
                        <i class="fas fa-download"></i> Descargar Lista
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function copyEmailsFromModal() {
    const textarea = document.getElementById('emailListForCopy');
    textarea.select();
    textarea.setSelectionRange(0, 99999); // Para móviles
    
    navigator.clipboard.writeText(textarea.value).then(() => {
        showAppMessage('📋 Lista de correos copiada al portapapeles', 'success');
    }).catch(() => {
        // Fallback para navegadores antiguos
        document.execCommand('copy');
        showAppMessage('📋 Lista copiada (seleccione el texto si no funcionó)', 'info');
    });
}

function openEmailClientEmpty() {
    const subject = encodeURIComponent('Comunicación OCHA Maracaibo');
    const body = encodeURIComponent('Estimados colegas,\n\n\n\nSaludos cordiales,\nSub Oficina OCHA Maracaibo');
    window.open(`mailto:?subject=${subject}&body=${body}`);
    showAppMessage('📧 Cliente de correo abierto. Pegue la lista en el campo "Para:" o "CCO:"', 'info');
}
// ====== FUNCIONES PARA FILTRO DE GRUPOS ======

function setupGroupsFilter() {
    const groupsContainer = document.getElementById('groupsFilterContainer');
    
    if (savedGroups.length === 0) {
        groupsContainer.innerHTML = '<div class="no-groups-message">No hay grupos creados</div>';
        return;
    }
    
    groupsContainer.innerHTML = '';
    savedGroups.forEach((group, index) => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-filter-item';
        groupItem.onclick = (e) => {
            // Prevenir que los clics en botones activen el filtro
            if (e.target.classList.contains('group-action-btn') || e.target.closest('.group-action-btn')) {
                return;
            }
            toggleGroupFilter(group.id || index);
        };
        
        groupItem.innerHTML = `
            <div class="group-filter-header">
                <div class="group-filter-name">${group.name}</div>
                <div class="group-filter-count">${group.contacts.length}</div>
            </div>
            <div class="group-filter-description">${group.description || 'Sin descripción'}</div>
            <div class="group-filter-actions">
<button class="group-action-btn edit" onclick="openEditGroupFromSidebar('${group.id}')" title="Editar grupo y gestionar miembros">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="group-action-btn delete" onclick="deleteGroup('${group.id}')" title="Eliminar grupo">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        groupsContainer.appendChild(groupItem);
    });
}

// NUEVO: Abrir modal de edición desde sidebar
function openEditGroupFromSidebar(groupId) {
    // Abrir el modal primero
    document.getElementById('groupModal').classList.add('active');
    // Luego mostrar la vista de edición
    showEditGroupView(groupId);
}

function toggleGroupFilter(groupId) {
            const groupItems = document.querySelectorAll('.group-filter-item');

            // Si ya está activo el mismo grupo, desactivar
            if (activeFilters.selectedGroup === groupId) {
                activeFilters.selectedGroup = null;
                groupItems.forEach(item => item.classList.remove('active'));
            } else {
                // Activar el nuevo grupo
                activeFilters.selectedGroup = groupId;
                groupItems.forEach((item, index) => {
                    if (savedGroups[index] && savedGroups[index].id === groupId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            applyFilters();
        }

// FUNCIONES ANTIGUAS ELIMINADAS - Ahora se usa el nuevo sistema unificado:
// - showEditGroupView(groupId) - reemplaza a editGroup(groupId)
// - saveGroupChanges() - reemplaza a updateGroup() y saveGroup()
// - El modal unificado groupModal reemplaza a editGroupModal

function deleteGroup(groupId) {
            const group = savedGroups.find(g => g.id === groupId);
            if (!group) {
                showAppMessage('Grupo no encontrado', 'error');
                return;
            }
            
            currentDeletingGroup = {group, id: groupId};
            
            // Mostrar información del grupo
            const deleteInfo = document.getElementById('deleteGroupInfo');
            deleteInfo.innerHTML = `
                <h6 style="color: var(--color-ochablue); margin-bottom: 0.5rem;">${group.name}</h6>
                <p style="margin-bottom: 0.5rem;"><strong>Descripción:</strong> ${group.description || 'Sin descripción'}</p>
                <p style="margin-bottom: 0;"><strong>Contactos:</strong> ${group.contacts ? group.contacts.length : 0}</p>
            `;
            
            document.getElementById('deleteGroupModal').classList.add('active');
        }

function closeDeleteGroupModal() {
    document.getElementById('deleteGroupModal').classList.remove('active');
    currentDeletingGroup = null;
    
    const message = document.getElementById('deleteGroupModalMessage');
    message.textContent = '';
    message.className = 'status-message';
    message.style.display = 'none';
}

async function confirmDeleteGroup() {
            if (!currentDeletingGroup) {
                closeDeleteGroupModal();
                return;
            }
            
            try {
                const groupId = currentDeletingGroup.group.id;
                const groupName = currentDeletingGroup.group.name;
                
                // 1. Eliminar relaciones en contact_group_members (se eliminan automáticamente por CASCADE)
                // 2. Eliminar el grupo
                const { error } = await sb
                    .from('contact_groups')
                    .delete()
                    .eq('id', groupId);

                if (error) throw error;

                // 3. Eliminar del array local
                const groupIndex = savedGroups.findIndex(g => g.id === groupId);
                if (groupIndex !== -1) {
                    savedGroups.splice(groupIndex, 1);
                }

                // 4. Si el grupo eliminado estaba activo en el filtro, limpiar filtro
                if (activeFilters.selectedGroup === groupId) {
                    activeFilters.selectedGroup = null;
                    applyFilters();
                }

                setupGroupsFilter();
                
                showAppMessage(`Grupo "${groupName}" eliminado exitosamente`, 'success');
                closeDeleteGroupModal();
                
            } catch (error) {
                console.error('Error eliminando grupo:', error);
                const message = document.getElementById('deleteGroupModalMessage');
                message.textContent = 'Error al eliminar el grupo: ' + error.message;
                message.className = 'status-message status-error';
                message.style.display = 'block';
            }
        }
// ====== ARQUITECTURA MULTIESPACIO ======
// IMPORTANTE: Los contactos pueden pertenecer a múltiples espacios/grupos sin duplicación
//
// DISEÑO IMPLEMENTADO:
// 1. Espacios de Coordinación: Almacenados como string CSV en campo "espacio_coordinacion"
//    Ejemplo: "Protección, Salud, Educación"
//    - Cada contacto es UNA SOLA FILA en la tabla 'contacts'
//    - Aparece en múltiples filtros sin duplicar el registro
//
// 2. Grupos Personalizados: Relación Many-to-Many vía tabla intermedia
//    Tablas: contact_groups <-> contact_group_members <-> contacts
//    - Un contacto puede estar en N grupos
//    - Un grupo puede tener N contactos
//    - Integridad referencial garantizada por CASCADE DELETE
//
// VENTAJAS:
// - Sin duplicación de datos de contacto
// - Consultas rápidas (un solo JOIN para grupos)
// - Filtrado eficiente por espacio O(n) lineal
// - Escalable para grandes volúmenes
// ========================================

// Función para obtener espacios de coordinación como array
function getEspaciosAsArray(espacioString) {
    if (!espacioString) return [];

    if (typeof espacioString === 'string') {
        // Si tiene comas, dividir por comas (datos nuevos)
        if (espacioString.includes(',')) {
            return espacioString.split(',').map(e => e.trim()).filter(e => e.length > 0);
        }

        // Si NO tiene comas, dividir por patrones conocidos (datos legacy)
        const text = espacioString.trim();

        // Si el texto es corto (menos de 50 chars), probablemente es un solo valor
        if (text.length < 50) {
            return [text];
        }

        // Encontrar todas las posiciones donde inician los patrones conocidos
        const patterns = [
            'Foro Local de Coordinacion',
            'Grupo de Coordinacion de',
            'Grupo de Coordinacion',
            'Cluster de',
            'Cluster WASH',
            'Grupo Tecnico',
            'Grupo Intercluster',
            'Grupo de Trabajo',
            'Red '
        ];

        const splitPoints = [];

        patterns.forEach(pattern => {
            let index = 0;
            while ((index = text.indexOf(pattern, index)) !== -1) {
                splitPoints.push({ position: index, pattern: pattern });
                index += pattern.length;
            }
        });

        // Si no encontramos puntos de división, retornar el texto completo
        if (splitPoints.length === 0) {
            return [text];
        }

        // Ordenar por posición
        splitPoints.sort((a, b) => a.position - b.position);

        // Extraer segmentos entre los puntos de división
        const segments = [];
        for (let i = 0; i < splitPoints.length; i++) {
            const start = splitPoints[i].position;
            const end = (i + 1 < splitPoints.length) ? splitPoints[i + 1].position : text.length;
            const segment = text.substring(start, end).trim();

            if (segment.length > 0) {
                segments.push(segment);
            }
        }

        return segments.length > 0 ? segments : [text];
    }

    return [];
}

// FUNCIÓN DE PRUEBA - Ejecuta en consola: probarDivisionEspacios()
function probarDivisionEspacios() {
    console.log('🧪 === PRUEBA DE DIVISIÓN DE ESPACIOS ===\n');

    // Encontrar contacto de ejemplo (Jhozman)
    const contactoEjemplo = contacts.find(c => c.punto_focal?.includes('Jhozman'));

    if (contactoEjemplo) {
        console.log('📋 Contacto de prueba:', contactoEjemplo.punto_focal);
        console.log('📝 Campo original:', contactoEjemplo.espacio_coordinacion);
        console.log('\n🔪 División en array:');

        const espaciosArray = getEspaciosAsArray(contactoEjemplo.espacio_coordinacion);
        espaciosArray.forEach((espacio, i) => {
            console.log(`   ${i + 1}. "${espacio}"`);
        });

        console.log('\n✅ Total de espacios:', espaciosArray.length);
    } else {
        console.log('⚠️ No se encontró contacto de ejemplo');
    }

    // Probar también con todos los espacios únicos
    console.log('\n📊 Todos los espacios únicos en el sistema:');
    const todosLosEspacios = new Set();
    contacts.forEach(c => {
        getEspaciosAsArray(c.espacio_coordinacion).forEach(e => todosLosEspacios.add(e));
    });

    Array.from(todosLosEspacios).sort().forEach((e, i) => {
        console.log(`   ${i + 1}. "${e}"`);
    });

    return Array.from(todosLosEspacios).sort();
}

function downloadEmailList(emails) {
    const content = `Lista de Correos Electrónicos - OCHA Maracaibo
Fecha: ${new Date().toLocaleDateString('es-ES')}
Total de correos: ${emails.length}

=== PARA COPIAR Y PEGAR ===
${emails.join('; ')}

=== LISTA LÍNEA POR LÍNEA ===
${emails.join('\n')}

Generado desde: Sistema de Contactos Sub Oficina OCHA Maracaibo
`;

    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `correos_ocha_maracaibo_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showAppMessage(`📁 Archivo con ${emails.length} correos descargado`, 'success');
}
// ====== FUNCIONES PARA ENVÍO MASIVO DE MAGIC LINKS ======

// Función principal para envío masivo de magic links
function sendMassiveMagicLinks() {
    if (selectedContacts.size === 0) {
        showAppMessage('Seleccione al menos un contacto para enviar magic links', 'error');
        return;
    }
    
    const selectedContactsArray = Array.from(selectedContacts).map(id => 
        contacts.find(c => c.id === id)
    ).filter(Boolean);
    
    const contactsWithEmail = selectedContactsArray.filter(contact => contact.email);
    
    if (contactsWithEmail.length === 0) {
        showAppMessage('Los contactos seleccionados no tienen correos válidos', 'warning');
        return;
    }
    
    showMagicLinkMassiveModal(contactsWithEmail);
}

function showMagicLinkMassiveModal(contactsWithEmail) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-magic"></i> Envío Masivo de Magic Links
                </h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-notice">
                    <i class="fas fa-info-circle"></i>
                    <strong>Contactos seleccionados:</strong> ${contactsWithEmail.length} con correo válido.
                    <br>Se generará un magic link personalizado para cada contacto.
                </div>
                
                <!-- Vista previa de contactos -->
                <div style="margin: 1.5rem 0;">
                    <h5 style="color: var(--color-ochablue); margin-bottom: 1rem;">
                        <i class="fas fa-users"></i> Contactos a procesar:
                    </h5>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 1rem; background: #f8f9fa;">
                        ${contactsWithEmail.map(contact => `
                            <div style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <strong>${contact.organizacion}</strong> - ${contact.punto_focal}
                                <br><small style="color: #666;">${contact.email}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Opciones de envío -->
                <div style="border: 1px solid var(--color-ochablue); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">
                    <h5 style="color: var(--color-ochablue); margin-bottom: 1rem;">
                        <i class="fas fa-cog"></i> Opciones de Envío
                    </h5>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                            Asunto del correo:
                        </label>
                        <input type="text" id="magicLinkSubject" class="form-control" 
                               value="OCHA Maracaibo - Actualización de su información de contacto"
                               style="margin-bottom: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                            Mensaje personalizado:
                        </label>
                        <textarea id="magicLinkMessage" class="form-control" rows="6" style="resize: vertical;">Estimado/a {PUNTO_FOCAL},

Saludos desde la Sub Oficina OCHA Maracaibo.

Le escribimos desde la organización {ORGANIZACION} para solicitar que actualice su información de contacto en nuestro directorio humanitario.

Para actualizar su información de manera segura, haga clic en el siguiente enlace:

{MAGIC_LINK}

Este enlace es personalizado y seguro, válido por 24 horas.

Gracias por su colaboración en mantener actualizada la información de coordinación humanitaria.

Saludos cordiales,
Sub Oficina OCHA Maracaibo
jhozman.camacho@un.org</textarea>
                        <small style="color: #666; font-size: 0.8rem;">
                            Variables disponibles: {PUNTO_FOCAL}, {ORGANIZACION}, {MAGIC_LINK}
                        </small>
                    </div>
                </div>
                
                <!-- Opciones de método de envío -->
                <div style="border: 1px solid var(--ocha-green); border-radius: 8px; padding: 1.5rem;">
                    <h5 style="color: var(--ocha-green); margin-bottom: 1rem;">
                        <i class="fas fa-paper-plane"></i> Método de Envío
                    </h5>
                    
                    <div style="display: grid; gap: 1rem;">
                        <!-- Opción 1: Cliente de correo local -->
                        <div style="border: 1px solid var(--color-ochablue); border-radius: 6px; padding: 1rem;">
                            <h6 style="color: var(--color-ochablue); margin-bottom: 0.5rem;">
                                <i class="fas fa-desktop"></i> Cliente de Correo Local (Recomendado)
                            </h6>
                            <p style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Genera correos individuales que se abren en su cliente de correo (Outlook, Apple Mail, etc.)
                            </p>
                            <button class="btn btn-primary" onclick="generateLocalEmails()">
                                <i class="fas fa-envelope"></i> Generar Correos Locales
                            </button>
                        </div>
                        
                        <!-- Opción 2: Lista para envío manual -->
                        <div style="border: 1px solid var(--color-ochagrey); border-radius: 6px; padding: 1rem;">
                            <h6 style="color: var(--color-ochagrey); margin-bottom: 0.5rem;">
                                <i class="fas fa-list"></i> Lista para Envío Manual
                            </h6>
                            <p style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Genera una lista con todos los correos y magic links para envío manual
                            </p>
                            <button class="btn btn-secondary" onclick="generateManualList()">
                                <i class="fas fa-file-text"></i> Generar Lista Manual
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="magicLinkModalMessage" class="status-message" style="margin-top: 1rem;"></div>
                <div id="magicLinkProgress" style="margin-top: 1rem; display: none;">
                    <div style="background: var(--ocha-light-blue); border-radius: 6px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span id="progressText">Procesando...</span>
                            <span id="progressCount">0/0</span>
                        </div>
                        <div style="background: #ddd; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="progressBar" style="background: var(--color-ochablue); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Generar correos individuales para cliente local
async function generateLocalEmails() {
    const contactsWithEmail = Array.from(selectedContacts).map(id => 
        contacts.find(c => c.id === id)
    ).filter(contact => contact && contact.email);
    
    const subject = document.getElementById('magicLinkSubject').value;
    const messageTemplate = document.getElementById('magicLinkMessage').value;
    
    showProgress(true, 'Generando magic links...', 0, contactsWithEmail.length);
    
    try {
        const emailsToSend = [];
        
        for (let i = 0; i < contactsWithEmail.length; i++) {
            const contact = contactsWithEmail[i];
            updateProgress(i + 1, contactsWithEmail.length, `Generando magic link para ${contact.organizacion}...`);
            
            // Generar magic link
            const magicLink = await generateRealMagicLink(contact.email, contact.id);
            
            // Personalizar mensaje
            const personalizedMessage = messageTemplate
                .replace(/{PUNTO_FOCAL}/g, contact.punto_focal || 'Estimado/a')
                .replace(/{ORGANIZACION}/g, contact.organizacion || 'su organización')
                .replace(/{MAGIC_LINK}/g, magicLink);
            
            emailsToSend.push({
                email: contact.email,
                subject: subject,
                body: personalizedMessage,
                contact: contact
            });
            
            // Pequeña pausa para no sobrecargar
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        showProgress(false);
        
        // Mostrar opciones de envío
        showEmailSendOptions(emailsToSend);
        
    } catch (error) {
        console.error('Error generando magic links:', error);
        showMagicLinkMessage('Error generando magic links: ' + error.message, 'error');
        showProgress(false);
    }
}

function showEmailSendOptions(emailsToSend) {
    const modalMessage = document.getElementById('magicLinkModalMessage');
    modalMessage.innerHTML = `
        <div style="background: var(--ocha-light-blue); border-radius: 6px; padding: 1.5rem;">
            <h6 style="color: var(--color-ochablue); margin-bottom: 1rem;">
                ✅ Magic Links Generados: ${emailsToSend.length} correos listos
            </h6>
            
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="sendEmailsBatch(${JSON.stringify(emailsToSend).replace(/"/g, '&quot;')}, 10)">
                    <i class="fas fa-paper-plane"></i> Enviar de 10 en 10
                </button>
                <button class="btn btn-info" onclick="sendEmailsBatch(${JSON.stringify(emailsToSend).replace(/"/g, '&quot;')}, 5)">
                    <i class="fas fa-paper-plane"></i> Enviar de 5 en 5
                </button>
                <button class="btn btn-warning" onclick="sendEmailsOneByOne(${JSON.stringify(emailsToSend).replace(/"/g, '&quot;')})">
                    <i class="fas fa-paper-plane"></i> Uno por Uno
                </button>
            </div>
            
            <button class="btn btn-secondary" onclick="downloadEmailList(${JSON.stringify(emailsToSend).replace(/"/g, '&quot;')})">
                <i class="fas fa-download"></i> Descargar Lista Completa
            </button>
        </div>
    `;
    modalMessage.className = 'status-message status-success';
    modalMessage.style.display = 'block';
}

// Enviar correos en lotes
function sendEmailsBatch(emailsToSend, batchSize) {
    const batches = [];
    for (let i = 0; i < emailsToSend.length; i += batchSize) {
        batches.push(emailsToSend.slice(i, i + batchSize));
    }
    
    showProgress(true, 'Abriendo clientes de correo...', 0, batches.length);
    
    batches.forEach((batch, index) => {
        setTimeout(() => {
            updateProgress(index + 1, batches.length, `Abriendo lote ${index + 1} de ${batches.length} (${batch.length} correos)`);
            
            batch.forEach((emailData, emailIndex) => {
                setTimeout(() => {
                    const subject = encodeURIComponent(emailData.subject);
                    const body = encodeURIComponent(emailData.body);
                    window.open(`mailto:${emailData.email}?subject=${subject}&body=${body}`);
                }, emailIndex * 500); // 500ms entre cada correo del lote
            });
            
            if (index === batches.length - 1) {
                setTimeout(() => {
                    showProgress(false);
                    showMagicLinkMessage(`🎉 Completado: ${batches.length} lotes enviados con ${emailsToSend.length} correos total`, 'success');
                }, batch.length * 500 + 1000);
            }
        }, index * (batchSize * 500 + 2000)); // Pausa entre lotes
    });
}

// Enviar correos uno por uno
function sendEmailsOneByOne(emailsToSend) {
    showProgress(true, 'Enviando correos individuales...', 0, emailsToSend.length);
    
    emailsToSend.forEach((emailData, index) => {
        setTimeout(() => {
            updateProgress(index + 1, emailsToSend.length, `Enviando a ${emailData.contact.organizacion}...`);
            
            const subject = encodeURIComponent(emailData.subject);
            const body = encodeURIComponent(emailData.body);
            window.open(`mailto:${emailData.email}?subject=${subject}&body=${body}`);
            
            if (index === emailsToSend.length - 1) {
                setTimeout(() => {
                    showProgress(false);
                    showMagicLinkMessage(`🎉 Todos los correos enviados: ${emailsToSend.length} magic links`, 'success');
                }, 1000);
            }
        }, index * 2000); // 2 segundos entre cada correo
    });
}

// Generar lista manual
async function generateManualList() {
    const contactsWithEmail = Array.from(selectedContacts).map(id => 
        contacts.find(c => c.id === id)
    ).filter(contact => contact && contact.email);
    
    const subject = document.getElementById('magicLinkSubject').value;
    const messageTemplate = document.getElementById('magicLinkMessage').value;
    
    showProgress(true, 'Generando lista manual...', 0, contactsWithEmail.length);
    
    try {
        let manualList = `LISTA DE MAGIC LINKS - OCHA MARACAIBO
Fecha: ${new Date().toLocaleDateString('es-ES')}
Total de contactos: ${contactsWithEmail.length}
Asunto: ${subject}

==========================================

`;

        for (let i = 0; i < contactsWithEmail.length; i++) {
            const contact = contactsWithEmail[i];
            updateProgress(i + 1, contactsWithEmail.length, `Procesando ${contact.organizacion}...`);
            
            const magicLink = await generateRealMagicLink(contact.email, contact.id);
            const personalizedMessage = messageTemplate
                .replace(/{PUNTO_FOCAL}/g, contact.punto_focal || 'Estimado/a')
                .replace(/{ORGANIZACION}/g, contact.organizacion || 'su organización')
                .replace(/{MAGIC_LINK}/g, magicLink);
            
            manualList += `${i + 1}. ${contact.organizacion} - ${contact.punto_focal}
Email: ${contact.email}
Magic Link: ${magicLink}

Mensaje personalizado:
${personalizedMessage}

==========================================

`;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        showProgress(false);
        
        // Descargar lista
        const blob = new Blob([manualList], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `magic_links_ocha_maracaibo_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showMagicLinkMessage(`📁 Lista manual descargada con ${contactsWithEmail.length} magic links`, 'success');
        
    } catch (error) {
        console.error('Error generando lista manual:', error);
        showMagicLinkMessage('Error generando lista manual: ' + error.message, 'error');
        showProgress(false);
    }
}

// Funciones auxiliares
function showProgress(show, text = '', current = 0, total = 0) {
    const progressDiv = document.getElementById('magicLinkProgress');
    if (show) {
        progressDiv.style.display = 'block';
        updateProgress(current, total, text);
    } else {
        progressDiv.style.display = 'none';
    }
}

function updateProgress(current, total, text) {
    const progressText = document.getElementById('progressText');
    const progressCount = document.getElementById('progressCount');
    const progressBar = document.getElementById('progressBar');
    
    if (progressText) progressText.textContent = text;
    if (progressCount) progressCount.textContent = `${current}/${total}`;
    if (progressBar) {
        const percentage = total > 0 ? (current / total) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
    }
}

function showMagicLinkMessage(message, type) {
    const messageEl = document.getElementById('magicLinkModalMessage');
    messageEl.textContent = message;
    messageEl.className = `status-message status-${type}`;
    messageEl.style.display = 'block';
}
// === FUNCIONES PARA NUEVO USUARIO ===
let currentNewUserData = null;

function showNewUserMagicLinkModal() {
    document.getElementById('newUserMagicLinkModal').classList.add('active');
    document.getElementById('newUserLinkResult').style.display = 'none';
    document.getElementById('newUserQRContainer').style.display = 'none';
    clearNewUserMessage();
}

function closeNewUserMagicLinkModal() {
    document.getElementById('newUserMagicLinkModal').classList.remove('active');
    currentNewUserData = null;
    clearNewUserMessage();
}

async function generateNewUserMagicLink() {
    const description = document.getElementById('linkDescription').value.trim() || 'Registro general';
    
    try {
        showNewUserMessage('Generando enlace público...', 'info');
        
        const publicToken = generateSecureToken();
        const appConfig = getAppConfig();
        const publicLink = `${appConfig.baseUrl}?public_register=true&token=${publicToken}&desc=${encodeURIComponent(description)}`;
        
        document.getElementById('generatedForEmail').textContent = 'Cualquier persona';
        document.getElementById('generatedMagicLink').value = publicLink;
        document.getElementById('newUserLinkResult').style.display = 'block';
        
        currentNewUserData = {
            description: description,
            link: publicLink,
            token: publicToken
        };
        
        showNewUserMessage('Enlace público generado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error generando enlace público:', error);
        showNewUserMessage('Error generando enlace: ' + error.message, 'error');
    }
}

function copyNewUserLink() {
    const linkTextarea = document.getElementById('generatedMagicLink');
    linkTextarea.select();
    linkTextarea.setSelectionRange(0, 99999);
    
    navigator.clipboard.writeText(linkTextarea.value).then(() => {
        showNewUserMessage('Enlace copiado al portapapeles', 'success');
    }).catch(() => {
        document.execCommand('copy');
        showNewUserMessage('Enlace copiado', 'success');
    });
}

function sendNewUserEmail() {
    if (!currentNewUserData) return;
    
    const subject = encodeURIComponent('OCHA Maracaibo - Enlace de registro de contactos');
    const body = encodeURIComponent(`Estimados colegas,

Saludos desde la Sub Oficina OCHA Maracaibo.

Compartimos el siguiente enlace para que las organizaciones humanitarias puedan registrarse en nuestro directorio de contactos:

${currentNewUserData.link}

Descripción: ${currentNewUserData.description}

Este enlace puede ser compartido libremente con cualquier organización que desee formar parte del directorio de coordinación humanitaria.

Saludos cordiales,
Sub Oficina OCHA Maracaibo`);
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
    showNewUserMessage('Cliente de correo abierto para compartir', 'info');
}
function showNewUserQR() {
    if (!currentNewUserData) return;
    
    const qrContainer = document.getElementById('newUserQRContainer');
    const qrCodeDiv = document.getElementById('newUserQRCode');
    
    qrContainer.style.display = 'block';
    qrCodeDiv.innerHTML = '';
    
    try {
        const qr = new QRCode(qrCodeDiv, {
            text: currentNewUserData.link,
            width: 256,
            height: 256,
            colorDark: '#0072BC',
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.L
        });
        
        showNewUserMessage('Código QR generado', 'success');
    } catch (error) {
        console.error('Error generando QR:', error);
        qrCodeDiv.innerHTML = '<p style="color: red;">Error generando QR</p>';
    }
}

function downloadNewUserQR() {
    try {
        const qrCanvas = document.querySelector('#newUserQRCode canvas');
        if (qrCanvas) {
            const link = document.createElement('a');
            link.download = `nuevo-usuario-qr.png`;
            link.href = qrCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNewUserMessage('QR descargado exitosamente', 'success');
        }
    } catch (error) {
        console.error('Error descargando QR:', error);
        showNewUserMessage('Error descargando QR', 'error');
    }
}

function showNewUserMessage(message, type) {
    const messageEl = document.getElementById('newUserModalMessage');
    messageEl.textContent = message;
    messageEl.className = `status-message status-${type}`;
    messageEl.style.display = 'block';
    
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }
}

function clearNewUserMessage() {
    const messageEl = document.getElementById('newUserModalMessage');
    messageEl.textContent = '';
    messageEl.className = 'status-message';
    messageEl.style.display = 'none';
}
// === REGISTRO PÚBLICO ===
function showPublicRegistration() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    
    // Crear formulario público
    const publicRegisterDiv = document.createElement('div');
    publicRegisterDiv.id = 'publicRegister';
    publicRegisterDiv.innerHTML = `
        <div class="login-container">
            <div class="login-box" style="max-width: 800px;">
                <div class="login-logo">
                    <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA Logo">
                </div>
                <h2 class="login-main-title">Registro de Contacto Humanitario</h2>
                <h3 class="login-form-title">Complete toda su información</h3>
                
                <form id="publicRegisterForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Organización *</label>
                            <input type="text" id="pub_organizacion" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Siglas</label>
                            <input type="text" id="pub_siglas" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Organización</label>
                            <select id="pub_tipo_organizacion" class="form-control">
                                <option value="">Seleccionar tipo</option>
                                <option value="ONG Nacional">ONG Nacional</option>
                                <option value="ONG Local">ONG Local</option>
                                <option value="ONG Internacional">ONG Internacional</option>
                                <option value="AFP Naciones Unidas">AFP Naciones Unidas</option>
                                <option value="Gobierno Local">Gobierno Local</option>
                                <option value="Gobierno Nacional">Gobierno Nacional</option>
                                <option value="Organización Religiosa">Organización Religiosa</option>
                                <option value="Sector Privado">Sector Privado</option>
                                <option value="Academia">Academia</option>
                                <option value="Red/Coalición">Red/Coalición</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Punto Focal *</label>
                            <input type="text" id="pub_punto_focal" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cargo</label>
                            <input type="text" id="pub_cargo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="pub_email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" id="pub_telefono" class="form-control" placeholder="+58 414-1234567">
                        </div>
                        <div class="form-group form-grid-full">
                            <label class="form-label">Grupo de Coordinación</label>
                            <div id="pub_espaciosMultiSelect" class="multi-select-list"></div>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--color-ochablue); margin: 1.5rem 0 1rem;">Sectores</h4>
                    <div id="pub_sectoresMultiSelect" class="multi-select-list"></div>
                    
                    <h4 style="color: var(--color-ochablue); margin: 1.5rem 0 1rem;">Municipios</h4>
                    <div id="pub_municipiosMultiSelect" class="multi-select-list"></div>
                    
                    <h4 style="color: var(--color-ochablue); margin: 1.5rem 0 1rem;">Participación</h4>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="pub_reporta_345w">
                            <label for="pub_reporta_345w">Reporta en el 345W</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="pub_socio_implementador">
                            <label for="pub_socio_implementador">Socio Implementador</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="pub_organizacion_lider">
                            <label for="pub_organizacion_lider">Organización Líder</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="pub_participacion_flc">
                            <label for="pub_participacion_flc">Participación FLC</label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" style="margin-top: 2rem;">
                        <i class="fas fa-save"></i> Registrar Contacto
                    </button>
                </form>
                
                <div id="publicRegisterMessage" class="status-message" style="margin-top: 1rem;"></div>
            </div>
        </div>
    `;
    
    document.body.appendChild(publicRegisterDiv);
    
    // Configurar las listas de selección múltiple
    setupPublicMultiSelectLists();
    
    document.getElementById('publicRegisterForm').addEventListener('submit', handlePublicRegistration);
}

function setupPublicMultiSelectLists() {
    // Sectores
    const sectoresContainer = document.getElementById('pub_sectoresMultiSelect');
    sectoresContainer.innerHTML = '';
    sectoresList.forEach(sector => {
        const div = document.createElement('div');
        div.className = 'multi-select-item';
        div.innerHTML = `
            <input type="checkbox" id="pub_sector_${sector.replace(/[^a-zA-Z0-9]/g, '_')}" value="${sector}">
            <label for="pub_sector_${sector.replace(/[^a-zA-Z0-9]/g, '_')}">${sector}</label>
        `;
        sectoresContainer.appendChild(div);
    });

    // Municipios
    const municipiosContainer = document.getElementById('pub_municipiosMultiSelect');
    municipiosContainer.innerHTML = '';
    municipiosList.forEach(municipio => {
        const div = document.createElement('div');
        div.className = 'multi-select-item';
        div.innerHTML = `
            <input type="checkbox" id="pub_municipio_${municipio.replace(/[^a-zA-Z0-9]/g, '_')}" value="${municipio}">
            <label for="pub_municipio_${municipio.replace(/[^a-zA-Z0-9]/g, '_')}">${municipio}</label>
        `;
        municipiosContainer.appendChild(div);
    });

    // Espacios
    const espaciosContainer = document.getElementById('pub_espaciosMultiSelect');
    espaciosContainer.innerHTML = '';
    espaciosList.forEach(espacio => {
        const div = document.createElement('div');
        div.className = 'multi-select-item';
        div.innerHTML = `
            <input type="checkbox" id="pub_espacio_${espacio.replace(/[^a-zA-Z0-9]/g, '_')}" value="${espacio}">
            <label for="pub_espacio_${espacio.replace(/[^a-zA-Z0-9]/g, '_')}">${espacio}</label>
        `;
        espaciosContainer.appendChild(div);
    });
}

async function handlePublicRegistration(e) {
    e.preventDefault();
    
    // Recopilar sectores seleccionados
    const selectedSectores = [];
    document.querySelectorAll('#pub_sectoresMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
        selectedSectores.push(checkbox.value);
    });
    
    // Recopilar municipios seleccionados
    const selectedMunicipios = [];
    document.querySelectorAll('#pub_municipiosMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
        selectedMunicipios.push(checkbox.value);
    });
    
    // Recopilar espacios seleccionados
    const selectedEspacios = [];
    document.querySelectorAll('#pub_espaciosMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
        selectedEspacios.push(checkbox.value);
    });
    
    const contactData = {
        organizacion: document.getElementById('pub_organizacion').value.trim(),
        siglas: document.getElementById('pub_siglas').value.trim(),
        punto_focal: document.getElementById('pub_punto_focal').value.trim(),
        cargo: document.getElementById('pub_cargo').value.trim(),
        email: document.getElementById('pub_email').value.trim().toLowerCase(),
        Teléfono: document.getElementById('pub_telefono').value.trim(),
        tipo_organizacion: document.getElementById('pub_tipo_organizacion').value.trim(),
        espacio_coordinacion: selectedEspacios.join(', '),
        sectores_concat: selectedSectores.join(', '),
        municipios_concat: selectedMunicipios.join(', '),
        reporta_345w: document.getElementById('pub_reporta_345w').checked,
        socio_implementador: document.getElementById('pub_socio_implementador').checked,
        organizacion_lider: document.getElementById('pub_organizacion_lider').checked,
        participacion_flc: document.getElementById('pub_participacion_flc').checked,
        
    };
    
    try {
        // Usar una función especial que omita RLS para registros públicos
        const { data, error } = await sb.functions.invoke('public-contact-registration', {
            body: contactData
        });
        
        if (error) throw error;
        
        const messageEl = document.getElementById('publicRegisterMessage');
        messageEl.textContent = '¡Contacto registrado exitosamente! Su información ha sido enviada para revisión.';
        messageEl.className = 'status-message status-success';
        messageEl.style.display = 'block';
        
        document.getElementById('publicRegisterForm').style.display = 'none';
        
    } catch (error) {
        console.error('Error registrando contacto:', error);
        
        // Fallback: Intentar inserción directa (puede fallar por RLS)
        try {
            const { error: directError } = await sb.from('contacts').insert([contactData]);
            if (directError) throw directError;
            
            const messageEl = document.getElementById('publicRegisterMessage');
            messageEl.textContent = '¡Contacto registrado exitosamente!';
            messageEl.className = 'status-message status-success';
            messageEl.style.display = 'block';
            
            document.getElementById('publicRegisterForm').style.display = 'none';
        } catch (fallbackError) {
            console.error('Error en fallback:', fallbackError);
            const messageEl = document.getElementById('publicRegisterMessage');
            messageEl.textContent = 'Error al registrar: ' + (fallbackError.message || 'Problema de permisos. Contacte al administrador.');
            messageEl.className = 'status-message status-error';
            messageEl.style.display = 'block';
        }
    }
}
    </script>

<script>
// Forzar modo sin autenticacion incluso si algun handler muestra login
if (typeof DISABLE_AUTH !== 'undefined' && DISABLE_AUTH) {
    document.addEventListener('DOMContentLoaded', () => {
        const login = document.getElementById('loginPage');
        const app = document.getElementById('mainApp');
        if (login) login.style.display = 'none';
        if (app) app.style.display = 'block';
        appInitialized = false;
        if (typeof initializeApp === 'function') {
            initializeApp();
        }
    });
}
</script>

        <!-- Modal clave de acceso (modo sin autenticaci?n) -->
    <div id="accessModal" class="modal">
        <div class="modal-content" style="max-width: 440px;">
            <div class="brand" style="margin-bottom: 0.5rem;">
                <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA" style="height:42px;">
                <div class="brand-text">
                    <div class="brand-title">Sub Oficina OCHA Maracaibo</div>
                    <div class="brand-subtitle">Herramienta de uso exclusivo del personal OCHA</div>
                </div>
            </div>
            <div class="modal-header" style="padding: 0; border: none; margin-bottom: 0.5rem;">
                <h3 class="modal-title">Ingresa tu contraseña</h3>
                <button class="modal-close" onclick="closeAccessModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 0.75rem; color: #475569;">Para volver a ver los datos, ingresa tu contraseña.</p>
                <div class="form-group">
                    <label class="form-label" for="accessPassword">Contraseña</label>
                    <div class="password-container">
                        <input type="password" id="accessPassword" class="form-control" placeholder="••••••••">
                        <button type="button" class="password-toggle" onclick="togglePassword('accessPassword')">
                            <i class="fas fa-eye" id="accessPasswordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div id="accessModalMessage" class="status-message" style="display:none;"></div>
            </div>
            <div class="modal-footer" style="border-top: none; padding-top: 0;">
                <button type="button" class="btn btn-secondary" onclick="closeAccessModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitAccessPassword()">
                    <i class="fas fa-unlock"></i> Acceder
                </button>
            </div>
        </div>
    </div>
</body>
</html>
