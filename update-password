<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer contraseña</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --color-ochablue: #0072bc;
            --color-ochablue-600: #0b74c0;
            --color-ochagrey: #4a4a4a;
            --color-ochalight: #f5f8fb;
            --color-border: #e5e7eb;
        }
        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0b74c0 0%, #005a8a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-ochagrey);
            padding: 1.5rem;
        }
        .card {
            background: #fff;
            padding: 2.25rem;
            border-radius: 16px;
            box-shadow: 0 18px 48px rgba(0,0,0,0.12);
            width: min(460px, 96vw);
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,114,188,0.08), rgba(0,114,188,0));
            pointer-events: none;
        }
        .card-content {
            position: relative;
            z-index: 1;
        }
        h1 {
            margin: 0 0 0.35rem 0;
            color: #0f172a;
            font-size: 1.6rem;
        }
        p {
            margin: 0 0 1.5rem 0;
            line-height: 1.6;
            color: #475569;
        }
        label {
            display: block;
            margin-bottom: 0.35rem;
            font-weight: 600;
            color: #1f2937;
        }
        input[type="password"] {
            width: 100%;
            padding: 0.9rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #f8fafc;
        }
        input[type="password"]:focus {
            outline: none;
            border-color: var(--color-ochablue);
            box-shadow: 0 0 0 4px rgba(0,114,188,0.18);
            background: #fff;
        }
        button {
            width: 100%;
            margin-top: 1rem;
            padding: 0.95rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--color-ochablue) 0%, var(--color-ochablue-600) 100%);
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 12px 24px rgba(0,114,188,0.28);
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 28px rgba(0,114,188,0.32);
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .status {
            border-radius: 10px;
            padding: 0.85rem 1rem;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.95rem;
        }
        .status.info { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
        .status.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecdd3; }
        .status.success { background: #ecfdf3; color: #166534; border: 1px solid #bbf7d0; }
        .footer {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .brand img {
            height: 44px;
        }
        .brand-text {
            line-height: 1.35;
        }
        .brand-title {
            font-weight: 700;
            color: #0f172a;
        }
        .brand-subtitle {
            font-size: 0.95rem;
            color: #475569;
        }
        .password-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            font-size: 1rem;
        }
        .password-toggle:hover { color: var(--color-ochablue); }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-content">
            <div class="brand">
                <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="OCHA">
                <div class="brand-text">
                    <div class="brand-title">Sub Oficina OCHA Maracaibo</div>
                    <div class="brand-subtitle">Herramienta de uso exclusivo OCHA Maracaibo</div>
                </div>
            </div>
            <div id="status" class="status info">Validando enlace...</div>
            <form id="resetForm" style="display:none;">
                <label for="newPassword">Nueva contrasena</label>
                <div class="password-container">
                    <input type="password" id="newPassword" autocomplete="new-password" required placeholder="••••••••">
                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                        <i class="fas fa-eye" id="newPasswordToggleIcon"></i>
                    </button>
                </div>
                <label for="confirmPassword" style="margin-top:0.75rem;">Confirmar contrasena</label>
                <div class="password-container">
                    <input type="password" id="confirmPassword" autocomplete="new-password" required placeholder="••••••••">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                        <i class="fas fa-eye" id="confirmPasswordToggleIcon"></i>
                    </button>
                </div>
                <button type="submit" id="submitBtn">Actualizar contrasena</button>
            </form>
            <div class="footer">Si el enlace no funciona, solicita uno nuevo desde "Olvide mi contrasena".</div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://gvobuytrtqxyvognivdt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2b2J1eXRydHF4eXZvZ25pdmR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNDczMTQsImV4cCI6MjA3MDYyMzMxNH0.34oUejp5IwN5vfFXSEPoJRZbFDv7b2aWHpDuE1pV1nE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storage: window.localStorage,
                storageKey: 'ocha-maracaibo-auth',
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        const statusEl = document.getElementById('status');
        const formEl = document.getElementById('resetForm');
        const submitBtn = document.getElementById('submitBtn');

        function showStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            statusEl.style.display = 'none';
        }

        function getHashParams() {
            const hash = window.location.hash.startsWith('#') ? window.location.hash.substring(1) : window.location.hash;
            return new URLSearchParams(hash);
        }

        async function setSessionFromHash() {
            const params = getHashParams();
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            if (!access_token || !refresh_token) {
                showStatus('Enlace inválido o incompleto. Solicita un nuevo correo de recuperación.', 'error');
                return false;
            }
            const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
            if (error) {
                console.error('Error al establecer sesión:', error);
                showStatus('No se pudo validar el enlace. Pide un nuevo correo de recuperación.', 'error');
                return false;
            }
            return true;
        }

        async function init() {
            showStatus('Validando enlace...', 'info');
            const ok = await setSessionFromHash();
            if (!ok) return;
            hideStatus();
            formEl.style.display = 'block';
        }

        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideStatus();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                showStatus('Las contraseñas no coinciden.', 'error');
                return;
            }
            submitBtn.disabled = true;
            showStatus('Actualizando contraseña...', 'info');
            try {
                const { error } = await supabase.auth.updateUser({ password: newPassword });
                if (error) throw error;
                showStatus('Contraseña actualizada. Ya puedes ingresar con la nueva contraseña.', 'success');
                setTimeout(() => {
                    window.location.href = 'Contactos.html';
                }, 1500);
            } catch (err) {
                console.error('Error actualizando contraseña:', err);
                showStatus('No se pudo actualizar la contraseña: ' + (err.message || 'Error desconocido'), 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        function togglePassword(fieldId) {
            const input = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + 'ToggleIcon');
            if (!input || !icon) return;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
